<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≠ch Xu·∫•t PDF: L·ªãch S·ª≠ & T√¨m N√¢ng Cao</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        .highlight {
            background-color: #fde047;
            font-weight: bold;
            padding: 0 2px;
            border-radius: 2px;
            color: #000;
            border-bottom: 2px solid #eab308;
        }
        .file-header {
            background-color: #e0f2fe;
            border-left: 4px solid #0284c7;
            padding: 10px;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #0369a1;
            border-radius: 4px;
        }
        .result-content {
            white-space: pre-wrap;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 1em;
            line-height: 1.6;
            color: #334155;
        }
        .full-content-view {
            white-space: pre-wrap;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 0.95em;
            line-height: 1.6;
            background-color: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            margin-top: 10px;
            color: #1e293b;
            max-height: 500px; /* Gi·ªõi h·∫°n chi·ªÅu cao n·∫øu qu√° d√†i */
            overflow-y: auto;
        }
        .translation-block {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #cbd5e1;
            font-size: 0.9em;
            color: #475569;
            background-color: #f8fafc;
            padding: 8px;
            border-radius: 4px;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        .mini-loader {
            width: 14px;
            height: 14px;
            border-width: 2px;
            border-top-color: #64748b;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Tab Styles */
        .tab-btn {
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
            background-color: #eff6ff;
        }
        .tab-btn:hover:not(.active) {
            background-color: #f3f4f6;
            color: #374151;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal Styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: visible !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800 relative">

    <div class="max-w-6xl mx-auto p-4 md:p-6">
        <header class="mb-6 text-center relative">
            <h1 class="text-3xl font-bold text-blue-700 mb-2">Tr√≠ch Xu·∫•t PDF Th√¥ng Minh</h1>
            <p class="text-gray-600">T√¨m ki·∫øm n√¢ng cao, L·ªãch s·ª≠ tra c·ª©u, OCR & D·ªãch thu·∫≠t</p>
            
            <!-- Bookmark Button -->
            <button onclick="toggleBookmarkModal()" class="absolute top-0 right-0 mt-2 md:mt-0 text-yellow-600 hover:text-yellow-700 font-medium flex items-center bg-yellow-50 hover:bg-yellow-100 px-3 py-1 rounded border border-yellow-200 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                </svg>
                Bookmarks
            </button>
        </header>

        <!-- INPUT AREA -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6 border border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Column 1: File Input & Link Paste -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">1. Ch·ªçn ngu·ªìn t√†i li·ªáu:</label>
                    
                    <!-- File Input -->
                    <input type="file" id="pdfInput" accept=".pdf" multiple
                        class="block w-full text-sm text-gray-500 mb-3
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100 cursor-pointer border border-gray-300 rounded-lg p-1"
                    />
                    
                    <!-- URL/Path Input with Datalist History -->
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                        </div>
                        <input type="text" id="urlInput" list="urlHistoryList" placeholder="D√°n Link Web ho·∫∑c Path..." 
                            class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            onkeypress="if(event.key === 'Enter') processPDFs()"
                        />
                        <datalist id="urlHistoryList">
                            <!-- Populated by JS -->
                        </datalist>
                    </div>
                    <div class="flex justify-between mt-1">
                        <p class="text-xs text-gray-400 italic" id="fileCountLabel">Ch∆∞a ch·ªçn file n√†o</p>
                        <button onclick="clearHistory('url')" class="text-xs text-red-300 hover:text-red-500">X√≥a l·ªãch s·ª≠ Link</button>
                    </div>
                </div>

                <!-- Column 2: Keywords & Search Options -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700">2. Nh·∫≠p t·ª´ kh√≥a</label>
                        <button onclick="clearHistory('keyword')" class="text-xs text-red-300 hover:text-red-500">X√≥a l·ªãch s·ª≠ t·ª´ kh√≥a</button>
                    </div>
                    
                    <div class="flex flex-col gap-2">
                        <div class="relative">
                             <input type="text" id="keywordInput" list="keywordHistoryList" placeholder="Nh·∫≠p t·ª´ kh√≥a..." 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                onkeypress="if(event.key === 'Enter') processPDFs()"
                            />
                            <datalist id="keywordHistoryList">
                                <!-- Populated by JS -->
                            </datalist>
                        </div>

                        <div class="flex gap-2">
                            <!-- Search Mode Dropdown -->
                            <select id="searchMode" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                                <option value="relative" selected>üîç T∆∞∆°ng ƒë·ªëi (Ch·ª©a)</option>
                                <option value="exact">üéØ Ch√≠nh x√°c (Nguy√™n t·ª´)</option>
                                <option value="smart">üß† Th√¥ng minh (ƒê·ªß √Ω)</option>
                            </select>

                            <button onclick="processPDFs()" id="btnProcess"
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow flex items-center justify-center whitespace-nowrap">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                T√¨m
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Options -->
            <div class="mt-4 flex flex-wrap items-center gap-4 text-sm">
                <div class="flex items-center mr-4">
                    <input type="checkbox" id="useOCR" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <label for="useOCR" class="ml-2 text-gray-700 cursor-pointer">B·∫≠t OCR (Qu√©t ·∫£nh)</label>
                </div>
                
                <div class="flex items-center mr-4">
                    <input type="checkbox" id="strictTable" checked class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                    <label for="strictTable" class="ml-2 text-gray-700 cursor-pointer">Ch·∫ø ƒë·ªô B·∫£ng (Gi·ªØ c·∫•u tr√∫c)</label>
                </div>

                <!-- T√°ch bi·ªát t√πy ch·ªçn d·ªãch -->
                <div class="flex items-center border-l pl-4 border-gray-300">
                    <input type="checkbox" id="translateViEn" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                    <label for="translateViEn" class="ml-2 font-medium text-purple-700 cursor-pointer">D·ªãch Vi·ªát ‚ûù Anh</label>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="translateEnVi" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                    <label for="translateEnVi" class="ml-2 font-medium text-purple-700 cursor-pointer">D·ªãch Anh ‚ûù Vi·ªát</label>
                </div>
            </div>

            <!-- Global Progress Bar (Shows when ANY search is running) -->
            <div id="globalProgressContainer" class="hidden mt-4 w-full bg-gray-200 rounded-full h-1.5">
                <div id="globalProgressBar" class="bg-blue-600 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- TABS CONTAINER -->
        <div id="mainTabsContainer" class="hidden">
            <!-- Tab Navigation -->
            <div class="flex overflow-x-auto border-b border-gray-200 mb-4 no-scrollbar" id="tabsNav">
                <!-- Tabs will be injected here -->
            </div>

            <!-- Tab Contents -->
            <div id="tabsContentArea">
                <!-- Content will be injected here -->
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-10 text-gray-400">
            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
            <p>K·∫øt qu·∫£ t√¨m ki·∫øm s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y</p>
        </div>

    </div>

    <!-- BOOKMARK MODAL -->
    <div id="bookmarkModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleBookmarkModal()"></div>
        
        <div class="modal-container bg-white w-11/12 md:max-w-lg mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            
            <div class="modal-content py-4 text-left px-6">
                <!-- Title -->
                <div class="flex justify-between items-center pb-3 border-b mb-4">
                    <p class="text-2xl font-bold text-gray-700">üìå Qu·∫£n l√Ω Bookmarks</p>
                    <div class="modal-close cursor-pointer z-50" onclick="toggleBookmarkModal()">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                        </svg>
                    </div>
                </div>

                <!-- Add New Form -->
                <div class="bg-gray-50 p-3 rounded-md mb-4 border border-gray-200">
                    <h4 class="text-sm font-semibold text-gray-600 mb-2">Th√™m m·ªõi:</h4>
                    <input type="text" id="bmName" placeholder="T√™n g·ª£i nh·ªõ (VD: T√†i li·ªáu d·ª± √°n X)" class="w-full mb-2 p-2 border rounded text-sm focus:outline-none focus:border-blue-500">
                    <input type="text" id="bmPath" placeholder="ƒê∆∞·ªùng d·∫´n folder ho·∫∑c Link Google Drive..." class="w-full mb-2 p-2 border rounded text-sm focus:outline-none focus:border-blue-500">
                    <button onclick="addBookmark()" class="w-full bg-blue-600 text-white p-2 rounded text-sm font-bold hover:bg-blue-700 transition">Th√™m Bookmark</button>
                </div>

                <!-- List -->
                <h4 class="text-sm font-semibold text-gray-600 mb-2">Danh s√°ch ƒë√£ l∆∞u:</h4>
                <div id="bookmarkList" class="space-y-2 max-h-60 overflow-y-auto pr-1">
                    <!-- Bookmark items will be generated here -->
                </div>

                <!-- Footer -->
                <div class="mt-4 pt-2 text-right border-t">
                    <button onclick="toggleBookmarkModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES & HELPERS ---
        let searchIdCounter = 0;
        let isProcessing = false;

        document.getElementById('pdfInput').addEventListener('change', function() {
            const count = this.files.length;
            document.getElementById('fileCountLabel').textContent = count > 0 ? `ƒê√£ ch·ªçn ${count} file` : 'Ch∆∞a ch·ªçn file n√†o';
        });

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // --- VIEW TOGGLE LOGIC (NEW) ---
        function toggleResultView(uniqueId) {
            const snippetDiv = document.getElementById(`snippet-${uniqueId}`);
            const fullDiv = document.getElementById(`full-${uniqueId}`);
            const btn = document.getElementById(`btn-${uniqueId}`);
            
            if (snippetDiv.classList.contains('hidden')) {
                // Currently showing Full -> Switch to Snippet
                snippetDiv.classList.remove('hidden');
                fullDiv.classList.add('hidden');
                btn.innerHTML = `üìñ Xem ƒë·∫ßy ƒë·ªß`;
                btn.classList.replace('bg-gray-500', 'bg-blue-100');
                btn.classList.replace('text-white', 'text-blue-700');
            } else {
                // Currently showing Snippet -> Switch to Full
                snippetDiv.classList.add('hidden');
                fullDiv.classList.remove('hidden');
                btn.innerHTML = `üîº Thu g·ªçn`;
                btn.classList.replace('bg-blue-100', 'bg-gray-500');
                btn.classList.replace('text-blue-700', 'text-white');
                
                // Auto scroll to the first highlight in full view if needed
                const firstHighlight = fullDiv.querySelector('.highlight');
                if (firstHighlight) {
                    firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        // --- HISTORY MANAGEMENT ---
        const HISTORY_KEYS = {
            keyword: 'pdf_history_keywords',
            url: 'pdf_history_urls'
        };

        function loadHistory() {
            updateDatalist('keywordHistoryList', HISTORY_KEYS.keyword);
            updateDatalist('urlHistoryList', HISTORY_KEYS.url);
        }

        function updateDatalist(elementId, storageKey) {
            const list = document.getElementById(elementId);
            list.innerHTML = '';
            const history = JSON.parse(localStorage.getItem(storageKey) || '[]');
            history.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                list.appendChild(option);
            });
        }

        function addToHistory(type, value) {
            if (!value) return;
            const key = type === 'keyword' ? HISTORY_KEYS.keyword : HISTORY_KEYS.url;
            let history = JSON.parse(localStorage.getItem(key) || '[]');
            history = history.filter(item => item !== value);
            history.unshift(value);
            if (history.length > 20) history.pop();
            localStorage.setItem(key, JSON.stringify(history));
            if (type === 'keyword') updateDatalist('keywordHistoryList', HISTORY_KEYS.keyword);
            else updateDatalist('urlHistoryList', HISTORY_KEYS.url);
        }

        function clearHistory(type) {
            if(confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch s·ª≠ ${type === 'keyword' ? 't·ª´ kh√≥a' : 'ƒë∆∞·ªùng d·∫´n'} kh√¥ng?`)) {
                const key = type === 'keyword' ? HISTORY_KEYS.keyword : HISTORY_KEYS.url;
                localStorage.removeItem(key);
                loadHistory();
            }
        }

        // --- BOOKMARK LOGIC ---
        const BOOKMARK_KEY = 'pdf_app_bookmarks';
        let bookmarks = [];

        function initBookmarks() {
            const stored = localStorage.getItem(BOOKMARK_KEY);
            if (stored) {
                try {
                    bookmarks = JSON.parse(stored);
                } catch (e) {
                    bookmarks = [];
                }
            }
            renderBookmarks();
        }

        function toggleBookmarkModal() {
            const body = document.querySelector('body');
            const modal = document.getElementById('bookmarkModal');
            modal.classList.toggle('opacity-0');
            modal.classList.toggle('pointer-events-none');
            body.classList.toggle('modal-active');
        }

        function addBookmark() {
            const nameInput = document.getElementById('bmName');
            const pathInput = document.getElementById('bmPath');
            const name = nameInput.value.trim();
            const path = pathInput.value.trim();
            if (!name || !path) { alert("Vui l√≤ng nh·∫≠p c·∫£ t√™n v√† ƒë∆∞·ªùng d·∫´n!"); return; }
            bookmarks.push({ name, path, id: Date.now() });
            localStorage.setItem(BOOKMARK_KEY, JSON.stringify(bookmarks));
            nameInput.value = ''; pathInput.value = '';
            renderBookmarks();
        }

        function deleteBookmark(id) {
            if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a bookmark n√†y?')) {
                bookmarks = bookmarks.filter(b => b.id !== id);
                localStorage.setItem(BOOKMARK_KEY, JSON.stringify(bookmarks));
                renderBookmarks();
            }
        }

        function copyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) alert("ƒê√£ copy ƒë∆∞·ªùng d·∫´n! B·∫°n h√£y d√°n (Ctrl+V) v√†o h·ªôp tho·∫°i ch·ªçn file.");
                else prompt("Kh√¥ng th·ªÉ t·ª± ƒë·ªông copy. H√£y copy th·ªß c√¥ng:", text);
            } catch (err) {
                prompt("H√£y copy th·ªß c√¥ng:", text);
            }
            document.body.removeChild(textArea);
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function renderBookmarks() {
            const container = document.getElementById('bookmarkList');
            container.innerHTML = '';
            if (bookmarks.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">Ch∆∞a c√≥ bookmark n√†o.</p>';
                return;
            }
            bookmarks.forEach(bm => {
                const isUrl = bm.path.startsWith('http');
                const safeName = escapeHtml(bm.name);
                const safePathDisplay = escapeHtml(bm.path);
                const encodedPath = encodeURIComponent(bm.path);
                const div = document.createElement('div');
                div.className = "flex items-center justify-between bg-white border p-2 rounded shadow-sm hover:shadow-md transition";
                let actionBtn = '';
                if (isUrl) {
                    actionBtn = `<a href="${safePathDisplay}" target="_blank" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded border border-green-200 hover:bg-green-200 flex items-center mr-2"><svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>M·ªü Link</a>`;
                } else {
                    actionBtn = `<button onclick="copyToClipboard(decodeURIComponent('${encodedPath}'))" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded border border-gray-200 hover:bg-gray-200 flex items-center mr-2" title="Copy ƒë∆∞·ªùng d·∫´n ƒë·ªÉ Paste v√†o c·ª≠a s·ªï ch·ªçn file"><svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>Copy Path</button>`;
                }
                div.innerHTML = `<div class="overflow-hidden mr-2"><div class="font-bold text-sm text-gray-700 truncate">${safeName}</div><div class="text-xs text-gray-400 truncate" title="${safePathDisplay}">${safePathDisplay}</div></div><div class="flex items-center shrink-0">${actionBtn}<button onclick="deleteBookmark(${bm.id})" class="text-red-400 hover:text-red-600 p-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>`;
                container.appendChild(div);
            });
        }
        window.addEventListener('DOMContentLoaded', () => { initBookmarks(); loadHistory(); });

        // --- LANGUAGE & TRANSLATION ---
        function isVietnameseText(text) { return /[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/i.test(text); }
        async function fetchAndDisplayTranslation(text, elementId) {
            const el = document.getElementById(elementId);
            if (!el) return;
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|vi&mt=1`);
                const data = await response.json();
                if (data && data.responseData && data.responseData.translatedText) {
                    el.innerHTML = `<span class="font-bold text-blue-600">üí° D·ªãch t·ª± ƒë·ªông:</span> <span class="italic">${data.responseData.translatedText}</span>`;
                } else { el.style.display = 'none'; }
            } catch (error) { el.innerHTML = `<span class="text-xs text-red-400">Kh√¥ng th·ªÉ t·∫£i b·∫£n d·ªãch</span>`; }
        }
        async function translateKeyword(text, langPair) {
            const detectedLabel = langPair === 'vi|en' ? 'Vi·ªát ‚ûù Anh' : 'Anh ‚ûù Vi·ªát';
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${langPair}&mt=1`);
                const data = await response.json();
                if (data.responseStatus !== 200) {
                    let errorMsg = data.responseDetails || "L·ªói t·ª´ d·ªãch v·ª• d·ªãch";
                    if (data.responseStatus === 429) errorMsg = "H·∫øt l∆∞·ª£t d·ªãch mi·ªÖn ph√≠";
                    return { text: null, label: detectedLabel, error: errorMsg };
                }
                if (data && data.responseData && data.responseData.translatedText) {
                    if (data.responseData.translatedText.includes("MYMEMORY WARNING")) {
                        return { text: null, label: detectedLabel, error: "H·∫øt l∆∞·ª£t d·ªãch" };
                    }
                    return { text: data.responseData.translatedText, label: detectedLabel, error: null };
                }
            } catch (error) { return { text: null, label: detectedLabel, error: "L·ªói m·∫°ng" }; }
            return { text: null, label: detectedLabel, error: "No Data" };
        }

        // --- TEXT EXTRACTION HELPER ---
        function extractTextWithLayout(textContent) {
            const items = textContent.items;
            if (items.length === 0) return "";
            items.sort((a, b) => {
                const yDiff = Math.abs(a.transform[5] - b.transform[5]);
                return yDiff < 4 ? a.transform[4] - b.transform[4] : b.transform[5] - a.transform[5];
            });
            let text = ""; let lastY = -1;
            for (const item of items) {
                if (lastY !== -1 && Math.abs(item.transform[5] - lastY) > 5) text += "\n";
                else if (lastY !== -1) text += "   ";
                text += item.str; lastY = item.transform[5];
            }
            return text + "\n";
        }

        // --- TAB MANAGEMENT LOGIC ---
        function createNewTab(keyword, translatedInfos) {
            searchIdCounter++;
            const tabId = `tab-${searchIdCounter}`;
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('mainTabsContainer').classList.remove('hidden');
            const tabBtn = document.createElement('button');
            tabBtn.className = 'tab-btn flex items-center px-4 py-2 mr-2 text-sm font-medium text-gray-500 bg-white border border-transparent rounded-t-lg hover:text-gray-700 hover:border-gray-300 focus:outline-none';
            tabBtn.dataset.target = tabId;
            tabBtn.innerHTML = `<span class="max-w-[100px] truncate" title="${keyword}">${keyword}</span><span class="ml-2 text-xs bg-gray-200 text-gray-600 rounded-full px-1.5 py-0.5" id="badge-${tabId}">...</span><span class="ml-2 text-gray-400 hover:text-red-500 rounded-full p-0.5" onclick="closeTab('${tabId}', event)"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></span>`;
            tabBtn.onclick = (e) => switchTab(tabId);
            document.getElementById('tabsNav').appendChild(tabBtn);
            const contentDiv = document.createElement('div');
            contentDiv.id = tabId;
            contentDiv.className = 'tab-content';
            let transHtml = '';
            if (translatedInfos && translatedInfos.length > 0) {
                const badges = translatedInfos.map(info => {
                    if (info.error) return `<div class="mr-2 mb-1 bg-yellow-50 text-yellow-800 text-xs px-3 py-1 rounded border border-yellow-200 inline-block" title="${info.error}"><span class="font-bold text-red-500">‚ö† ${info.label}:</span> ${info.error}</div>`;
                    else if (info.isDuplicate) return `<div class="mr-2 mb-1 bg-gray-50 text-gray-500 text-xs px-3 py-1 rounded border border-gray-200 inline-block italic"><span class="font-bold">${info.label}:</span> Tr√πng kh·ªõp (ƒê√£ b·ªè qua)</div>`;
                    else return `<div class="mr-2 mb-1 bg-blue-50 text-blue-800 text-xs px-3 py-1 rounded border border-blue-100 inline-block"><span class="font-bold">${info.label}:</span> "${keyword}" ‚Üî "${info.text}"</div>`;
                }).join('');
                transHtml = `<div class="mb-3 flex flex-wrap">${badges}</div>`;
            }
            contentDiv.innerHTML = `<div class="flex justify-between items-center mb-4"><h2 class="text-lg font-semibold text-gray-800">K·∫øt qu·∫£ cho: <span class="text-blue-600">"${keyword}"</span></h2><div id="status-${tabId}" class="text-sm font-medium text-orange-500 flex items-center"><div class="loader mr-2"></div> ƒêang kh·ªüi t·∫°o...</div></div>${transHtml}<ul id="list-${tabId}" class="space-y-4 pb-10 min-h-[200px]"></ul>`;
            document.getElementById('tabsContentArea').appendChild(contentDiv);
            switchTab(tabId);
            return tabId;
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const btn = document.querySelector(`.tab-btn[data-target="${tabId}"]`);
            const content = document.getElementById(tabId);
            if (btn && content) { btn.classList.add('active'); content.classList.add('active'); }
        }

        function closeTab(tabId, event) {
            event.stopPropagation();
            const btn = document.querySelector(`.tab-btn[data-target="${tabId}"]`);
            const content = document.getElementById(tabId);
            if (btn) btn.remove();
            if (content) content.remove();
            if (!document.querySelector('.tab-btn.active')) {
                const remainingBtns = document.querySelectorAll('.tab-btn');
                if (remainingBtns.length > 0) switchTab(remainingBtns[remainingBtns.length - 1].dataset.target);
                else { document.getElementById('mainTabsContainer').classList.add('hidden'); document.getElementById('emptyState').classList.remove('hidden'); }
            }
        }

        // --- MAIN PROCESSING LOGIC ---
        async function processPDFs() {
            const fileInput = document.getElementById('pdfInput');
            const keywordInput = document.getElementById('keywordInput');
            const urlInput = document.getElementById('urlInput');
            const searchMode = document.getElementById('searchMode').value;
            const useOCR = document.getElementById('useOCR').checked;
            const strictTable = document.getElementById('strictTable').checked;
            const useViEn = document.getElementById('translateViEn').checked;
            const useEnVi = document.getElementById('translateEnVi').checked;
            const globalProgressBar = document.getElementById('globalProgressBar');
            const globalProgressContainer = document.getElementById('globalProgressContainer');

            const originalKeyword = keywordInput.value.trim();
            const pastedUrl = urlInput.value.trim();
            const hasFiles = fileInput.files.length > 0;
            const hasUrl = pastedUrl.length > 0;

            if (!hasFiles && !hasUrl) { alert('Vui l√≤ng ch·ªçn file PDF ho·∫∑c nh·∫≠p Link/ƒê∆∞·ªùng d·∫´n.'); return; }
            if (!originalKeyword) { alert('Vui l√≤ng nh·∫≠p t·ª´ kh√≥a.'); return; }

            const localPathRegex = /^[a-zA-Z]:[\\\/]|^\\\\|^\/[a-zA-Z0-9]/;
            if (hasUrl && localPathRegex.test(pastedUrl)) {
                addToHistory('url', pastedUrl);
                alert("‚ö† C·∫¢NH B√ÅO: Tr√¨nh duy·ªát web kh√¥ng th·ªÉ ƒë·ªçc file tr·ª±c ti·∫øp t·ª´ ƒë∆∞·ªùng d·∫´n b·∫°n d√°n.\n\nüëâ GI·∫¢I PH√ÅP: Nh·∫•n 'Ch·ªçn File', sau ƒë√≥ d√°n ƒë∆∞·ªùng d·∫´n n√†y v√†o c·ª≠a s·ªï ch·ªçn file (Ctrl+V) -> Enter.");
                return;
            }

            addToHistory('keyword', originalKeyword);
            if(hasUrl) addToHistory('url', pastedUrl);

            isProcessing = true;
            document.getElementById('btnProcess').disabled = true;
            document.getElementById('btnProcess').classList.add('opacity-50', 'cursor-not-allowed');
            globalProgressContainer.classList.remove('hidden');
            globalProgressBar.style.width = '5%';

            let searchKeywords = [originalKeyword];
            let translatedInfos = [];

            if (useViEn) {
                const transResult = await translateKeyword(originalKeyword, 'vi|en');
                if (!transResult.error && transResult.text && transResult.text.toLowerCase() !== originalKeyword.toLowerCase()) {
                    searchKeywords.push(transResult.text); translatedInfos.push(transResult);
                } else if(transResult.text) { transResult.isDuplicate = true; translatedInfos.push(transResult); }
            }
            if (useEnVi) {
                const transResult = await translateKeyword(originalKeyword, 'en|vi');
                if (!transResult.error && transResult.text && transResult.text.toLowerCase() !== originalKeyword.toLowerCase() && !searchKeywords.includes(transResult.text)) {
                    searchKeywords.push(transResult.text); translatedInfos.push(transResult);
                } else if(transResult.text) { transResult.isDuplicate = true; translatedInfos.push(transResult); }
            }

            const tabId = createNewTab(originalKeyword, translatedInfos);
            const tabStatus = document.getElementById(`status-${tabId}`);
            const tabList = document.getElementById(`list-${tabId}`);
            const tabBadge = document.getElementById(`badge-${tabId}`);

            const sortedKeywords = [...searchKeywords].sort((a, b) => b.length - a.length);
            const lowerKeywords = searchKeywords.map(k => k.toLowerCase());
            const regexPattern = sortedKeywords.map(k => escapeRegExp(k)).join('|');
            const highlightRegex = new RegExp(`(${regexPattern})`, 'gi'); 
            const smartKeywordsParts = lowerKeywords.map(k => k.split(' ').filter(w => w.trim().length > 0));

            let worker = null;
            if (useOCR) {
                tabStatus.textContent = "ƒêang t·∫£i OCR Engine...";
                try { worker = await Tesseract.createWorker('vie'); } catch (e) { tabStatus.innerHTML = `<span class="text-red-500">L·ªói OCR: ${e.message}</span>`; cleanup(); return; }
            }

            try {
                let totalMatchesInTab = 0;
                const processingTasks = [];
                Array.from(fileInput.files).forEach(file => { processingTasks.push({ type: 'file', source: file, name: file.name }); });

                if (hasUrl) {
                    let fetchUrl = pastedUrl;
                    if (fetchUrl.includes('drive.google.com')) {
                         const match = fetchUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
                         if (match && match[1]) fetchUrl = `https://drive.google.com/uc?export=download&id=${match[1]}`;
                    }
                    processingTasks.push({ type: 'url', source: fetchUrl, name: "Link: " + (pastedUrl.length > 30 ? pastedUrl.substring(0,30)+'...' : pastedUrl) });
                }

                const totalTasks = processingTasks.length;

                for (let tIndex = 0; tIndex < totalTasks; tIndex++) {
                    const task = processingTasks[tIndex];
                    let fullText = "";
                    tabStatus.innerHTML = `<div class="loader mr-2"></div> ƒêang x·ª≠ l√Ω: ${task.name} (${tIndex + 1}/${totalTasks})`;

                    try {
                        let pdfData = null;
                        if (task.type === 'file') { pdfData = await task.source.arrayBuffer(); } 
                        else {
                            const fetchWithProxy = async (url) => {
                                try {
                                    const res = await fetch(url);
                                    if (res.ok) return await res.arrayBuffer();
                                    throw new Error(res.status);
                                } catch (e) {
                                    console.log("Direct fetch failed, trying proxy for: " + url);
                                    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
                                    const res = await fetch(proxyUrl);
                                    if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i (L·ªói CORS ho·∫∑c Link h·ªèng)");
                                    return await res.arrayBuffer();
                                }
                            }
                            pdfData = await fetchWithProxy(task.source);
                        }

                        const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                        const totalPages = pdf.numPages;

                        for (let i = 1; i <= totalPages; i++) {
                            const progress = ((tIndex + (i / totalPages)) / totalTasks) * 100;
                            globalProgressBar.style.width = `${progress}%`;
                            if (useOCR) {
                                const page = await pdf.getPage(i);
                                const viewport = page.getViewport({ scale: 2.0 });
                                const canvas = document.createElement('canvas');
                                const context = canvas.getContext('2d');
                                canvas.height = viewport.height; canvas.width = viewport.width;
                                await page.render({ canvasContext: context, viewport: viewport }).promise;
                                const { data: { text } } = await worker.recognize(canvas);
                                fullText += text + "\n"; 
                            } else {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                if (strictTable) fullText += extractTextWithLayout(textContent);
                                else fullText += textContent.items.map(item => item.str).join(' ') + " ";
                            }
                        }

                        let sentences = [];
                        if (strictTable || useOCR) sentences = fullText.match(/[^.!?\n]+[.!?\n]+|[^.!?\n]+$/g) || [];
                        else sentences = fullText.replace(/\s+/g, ' ').match(/[^.!?]+[.!?]+|[^.!?]+$/g) || [];

                        const cleanSentences = sentences.map(s => s.trim()).filter(s => s.length > 0);
                        const fileResults = [];

                        for (let sIdx = 0; sIdx < cleanSentences.length; sIdx++) {
                            const currentSentence = cleanSentences[sIdx];
                            const currentSentenceLower = currentSentence.toLowerCase();
                            let isMatch = false;

                            for (let kIdx = 0; kIdx < lowerKeywords.length; kIdx++) {
                                const kw = lowerKeywords[kIdx];
                                if (searchMode === 'exact') {
                                    const regex = new RegExp(`\\b${escapeRegExp(kw)}\\b`, 'i');
                                    if (regex.test(currentSentence)) { isMatch = true; break; }
                                } else if (searchMode === 'smart') {
                                    const parts = smartKeywordsParts[kIdx];
                                    if (parts.every(part => currentSentenceLower.includes(part))) { isMatch = true; break; }
                                } else {
                                    if (currentSentenceLower.includes(kw)) { isMatch = true; break; }
                                }
                            }

                            if (isMatch) {
                                const startIndex = Math.max(0, sIdx - 3);
                                const endIndex = Math.min(cleanSentences.length - 1, sIdx + 3);
                                const contextBlock = cleanSentences.slice(startIndex, endIndex + 1);
                                fileResults.push({ content: contextBlock, targetIndex: sIdx - startIndex });
                            }
                        }

                        if (fileResults.length > 0) {
                            totalMatchesInTab += fileResults.length;
                            const fileHeader = document.createElement('div');
                            fileHeader.className = "file-header";
                            fileHeader.innerHTML = `<div class="flex justify-between items-center"><span>üìÑ ${task.name}</span><span class="bg-blue-600 text-white text-xs px-2 py-1 rounded">${fileResults.length} k·∫øt qu·∫£</span></div>`;
                            tabList.appendChild(fileHeader);

                            fileResults.forEach((res, rIdx) => {
                                const li = document.createElement('li');
                                li.className = "bg-white p-4 rounded-lg shadow border-l-4 border-gray-300 hover:border-blue-500 transition mb-4 ml-4 overflow-x-auto";
                                const uniqueId = `${tabId}-${tIndex}-${rIdx}`;
                                
                                const htmlContent = res.content.map((line, idx) => {
                                    let displayLine = line.replace(/\n/g, ''); 
                                    if (searchMode === 'smart') {
                                         smartKeywordsParts.forEach(parts => { parts.forEach(part => { const partRegex = new RegExp(`(${escapeRegExp(part)})`, 'gi'); displayLine = displayLine.replace(partRegex, match => `<span class="highlight">${match}</span>`); }); });
                                    } else {
                                        displayLine = displayLine.replace(highlightRegex, match => `<span class="highlight">${match}</span>`);
                                    }
                                    if (idx === res.targetIndex) return `<div class="bg-blue-50 py-1 pl-2 border-l-2 border-blue-300 font-medium text-gray-900">${displayLine}</div>`;
                                    return `<div class="pl-2 opacity-70 text-gray-600">${displayLine}</div>`;
                                }).join('');

                                // Generate Full Text HTML
                                let fullHTML = fullText.replace(/[<>]/g, ""); // Basic sanitize
                                if (searchMode === 'smart') {
                                     smartKeywordsParts.forEach(parts => { parts.forEach(part => { const partRegex = new RegExp(`(${escapeRegExp(part)})`, 'gi'); fullHTML = fullHTML.replace(partRegex, match => `<span class="highlight">${match}</span>`); }); });
                                } else {
                                    fullHTML = fullHTML.replace(highlightRegex, match => `<span class="highlight">${match}</span>`);
                                }

                                const fullSnippetText = res.content.join(' ').replace(/\s+/g, ' ').trim();
                                let translationContainer = '';
                                if (!isVietnameseText(fullSnippetText)) {
                                    translationContainer = `<div class="translation-block" id="trans-${uniqueId}"><div class="loader mini-loader mr-2 align-middle inline-block"></div> <span class="italic text-gray-400">ƒêang d·ªãch ƒëo·∫°n vƒÉn n√†y...</span></div>`;
                                    fetchAndDisplayTranslation(fullSnippetText, `trans-${uniqueId}`);
                                }
                                
                                li.innerHTML = `
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="text-xs font-bold text-gray-400">K·∫øt qu·∫£ #${rIdx + 1}</div>
                                        <button id="btn-${uniqueId}" onclick="toggleResultView('${uniqueId}')" class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded border border-blue-200 transition">
                                            üìñ Xem ƒë·∫ßy ƒë·ªß
                                        </button>
                                    </div>
                                    <div id="snippet-${uniqueId}" class="result-content text-sm block">
                                        ${htmlContent}
                                    </div>
                                    <div id="full-${uniqueId}" class="full-content-view hidden">
                                        ${fullHTML}
                                    </div>
                                    ${translationContainer}
                                `;
                                tabList.appendChild(li);
                            });
                        }

                    } catch (taskErr) {
                        const errDiv = document.createElement('div');
                        errDiv.className = "p-3 bg-red-100 text-red-700 rounded mb-4 text-sm border border-red-200";
                        errDiv.textContent = `L·ªói x·ª≠ l√Ω ${task.name}: ${taskErr.message}`;
                        tabList.appendChild(errDiv);
                    }
                }

                if (totalMatchesInTab === 0) {
                    tabStatus.className = "text-sm font-bold text-red-500";
                    tabStatus.textContent = "Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o.";
                    if(tabList.children.length === 0) tabList.innerHTML = `<div class="text-center text-gray-400 italic mt-10">Kh√¥ng c√≥ d·ªØ li·ªáu tr√πng kh·ªõp.</div>`;
                } else {
                    tabStatus.className = "text-sm font-bold text-green-600";
                    tabStatus.textContent = `Ho√†n t·∫•t! T√¨m th·∫•y ${totalMatchesInTab} k·∫øt qu·∫£.`;
                }
                tabBadge.textContent = totalMatchesInTab;
                tabBadge.className = `ml-2 text-xs px-1.5 py-0.5 rounded-full text-white ${totalMatchesInTab > 0 ? 'bg-red-500' : 'bg-gray-400'}`;

            } catch (error) {
                console.error(error);
                tabStatus.className = "text-sm font-bold text-red-600";
                tabStatus.textContent = 'L·ªói h·ªá th·ªëng: ' + error.message;
            } finally {
                if (worker) await worker.terminate();
                cleanup();
            }
        }

        function cleanup() {
            isProcessing = false;
            document.getElementById('btnProcess').disabled = false;
            document.getElementById('btnProcess').classList.remove('opacity-50', 'cursor-not-allowed');
            document.getElementById('globalProgressBar').style.width = '0%';
            setTimeout(() => { if(!isProcessing) document.getElementById('globalProgressContainer').classList.add('hidden'); }, 1000);
        }
    </script>
</body>
</html>
