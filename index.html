<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≠ch Xu·∫•t PDF N√¢ng Cao (B·∫£ng & OCR)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        .highlight {
            background-color: #fde047;
            font-weight: bold;
            padding: 0 2px;
            border-radius: 2px;
            color: #000;
        }
        .file-header {
            background-color: #e0f2fe;
            border-left: 4px solid #0284c7;
            padding: 10px;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #0369a1;
            border-radius: 4px;
        }
        /* CSS ƒë·ªÉ hi·ªÉn th·ªã d·∫°ng b·∫£ng t·ªët h∆°n */
        .result-content {
            white-space: pre-wrap; /* Gi·ªØ nguy√™n xu·ªëng d√≤ng */
            font-family: 'Courier New', Courier, monospace; /* Font monospace ƒë·ªÉ c√°c c·ªôt th·∫≥ng h√†ng h∆°n */
            font-size: 0.9em;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">

    <div class="max-w-5xl mx-auto p-6">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-blue-700 mb-2">Tr√≠ch Xu·∫•t PDF & D·ªØ Li·ªáu B·∫£ng</h1>
            <p class="text-gray-600">H·ªó tr·ª£ t√¨m ki·∫øm trong b·∫£ng bi·ªÉu, nhi·ªÅu file v√† OCR</p>
        </header>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">1. Ch·ªçn file PDF (Gi·ªØ Ctrl ƒë·ªÉ ch·ªçn nhi·ªÅu)</label>
                    <input type="file" id="pdfInput" accept=".pdf" multiple
                        class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100 cursor-pointer border border-gray-300 rounded-lg p-1"
                    />
                    <p class="text-xs text-gray-400 mt-1 italic" id="fileCountLabel">Ch∆∞a ch·ªçn file n√†o</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">2. Nh·∫≠p t·ª´ kh√≥a</label>
                    <input type="text" id="keywordInput" placeholder="VD: 500.000, t√™n nh√¢n vi√™n..." 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    />
                </div>
            </div>

            <div class="mt-4 flex items-center justify-center space-x-6">
                <div class="flex items-center">
                    <input type="checkbox" id="useOCR" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                    <label for="useOCR" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer select-none">
                        B·∫≠t OCR (Cho file Scan)
                    </label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="strictTable" checked class="w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500">
                    <label for="strictTable" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer select-none">
                        Ch·∫ø ƒë·ªô B·∫£ng (Gi·ªØ c·∫•u tr√∫c d√≤ng)
                    </label>
                </div>
            </div>

            <div class="mt-6 text-center">
                <button onclick="processPDFs()" id="btnProcess"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-lg transition duration-200 flex items-center justify-center mx-auto space-x-2">
                    <span>B·∫Øt ƒê·∫ßu Qu√©t</span>
                </button>
            </div>
            
            <div id="progressContainer" class="hidden mt-4 w-full bg-gray-200 rounded-full h-2.5">
                <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <div id="statusMessage" class="mt-2 text-center text-sm text-gray-500 hidden font-medium"></div>
        </div>

        <div id="resultContainer" class="hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                T·ªïng K·∫øt Qu·∫£
                <span id="totalMatchCount" class="ml-2 bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded">0</span>
            </h2>
            <ul id="resultsList" class="space-y-4 pb-10"></ul>
        </div>
    </div>

    <script>
        document.getElementById('pdfInput').addEventListener('change', function() {
            const count = this.files.length;
            document.getElementById('fileCountLabel').textContent = count > 0 ? `ƒê√£ ch·ªçn ${count} file` : 'Ch∆∞a ch·ªçn file n√†o';
        });

        // H√†m s·∫Øp x·∫øp text items ƒë·ªÉ t√°i t·∫°o d√≤ng (cho b·∫£ng)
        function extractTextWithLayout(textContent) {
            const items = textContent.items;
            if (items.length === 0) return "";

            // S·∫Øp x·∫øp items: ∆Øu ti√™n Y (ƒë·∫£o ng∆∞·ª£c v√¨ PDF Y=0 ·ªü d∆∞·ªõi), sau ƒë√≥ ƒë·∫øn X
            // Sai s·ªë cho ph√©p c·ªßa Y l√† 2 ƒë∆°n v·ªã (ƒë·ªÉ x·ª≠ l√Ω ch·ªØ b·ªã l·ªách nh·∫π c√πng d√≤ng)
            items.sort((a, b) => {
                const yDiff = Math.abs(a.transform[5] - b.transform[5]);
                if (yDiff < 4) { // C√πng d√≤ng
                    return a.transform[4] - b.transform[4]; // Sort theo X
                }
                return b.transform[5] - a.transform[5]; // Sort theo Y (tr√™n xu·ªëng d∆∞·ªõi)
            });

            let text = "";
            let lastY = -1;
            
            for (const item of items) {
                if (lastY !== -1 && Math.abs(item.transform[5] - lastY) > 5) {
                    text += "\n"; // Xu·ªëng d√≤ng n·∫øu Y thay ƒë·ªïi ƒë√°ng k·ªÉ
                } else if (lastY !== -1) {
                    text += "   "; // Th√™m kho·∫£ng tr·∫Øng gi·∫£ l·∫≠p kho·∫£ng c√°ch c·ªôt
                }
                text += item.str;
                lastY = item.transform[5];
            }
            return text + "\n"; // K·∫øt th√∫c trang b·∫±ng xu·ªëng d√≤ng
        }

        async function processPDFs() {
            const fileInput = document.getElementById('pdfInput');
            const keywordInput = document.getElementById('keywordInput');
            const useOCR = document.getElementById('useOCR').checked;
            const strictTable = document.getElementById('strictTable').checked;
            
            const statusMsg = document.getElementById('statusMessage');
            const resultsList = document.getElementById('resultsList');
            const resultContainer = document.getElementById('resultContainer');
            const btnProcess = document.getElementById('btnProcess');
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('progressContainer');
            const totalMatchBadge = document.getElementById('totalMatchCount'); // ƒê√£ th√™m d√≤ng n√†y

            // Reset
            resultsList.innerHTML = '';
            resultContainer.classList.add('hidden');
            progressContainer.classList.add('hidden');
            progressBar.style.width = '0%';
            statusMsg.classList.remove('hidden');
            statusMsg.innerHTML = '';
            let totalMatchesGlobal = 0;

            if (fileInput.files.length === 0) { alert('Vui l√≤ng ch·ªçn file PDF.'); return; }
            if (!keywordInput.value.trim()) { alert('Vui l√≤ng nh·∫≠p t·ª´ kh√≥a.'); return; }

            const files = Array.from(fileInput.files);
            const keyword = keywordInput.value.trim();
            const lowerKeyword = keyword.toLowerCase();

            btnProcess.disabled = true;
            btnProcess.innerHTML = '<div class="loader"></div><span class="ml-2">ƒêang x·ª≠ l√Ω...</span>';
            progressContainer.classList.remove('hidden');

            let worker = null;
            if (useOCR) {
                statusMsg.textContent = 'ƒêang kh·ªüi ƒë·ªông OCR...';
                try {
                    worker = await Tesseract.createWorker('vie');
                } catch (e) {
                    alert("L·ªói t·∫£i th∆∞ vi·ªán OCR. Ki·ªÉm tra m·∫°ng.");
                    btnProcess.disabled = false;
                    return;
                }
            }

            try {
                for (let fIndex = 0; fIndex < files.length; fIndex++) {
                    const file = files[fIndex];
                    let fullText = "";
                    statusMsg.textContent = `File ${fIndex + 1}/${files.length}: ${file.name}`;
                    
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    const totalPages = pdf.numPages;

                    for (let i = 1; i <= totalPages; i++) {
                        const progress = ((fIndex + (i / totalPages)) / files.length) * 100;
                        progressBar.style.width = `${progress}%`;
                        statusMsg.textContent = `File ${fIndex + 1}: ${file.name} (Trang ${i})`;

                        if (useOCR) {
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height; canvas.width = viewport.width;
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            
                            // Tesseract t·ª± ƒë·ªông gi·ªØ d√≤ng (newline) t·ªët
                            const { data: { text } } = await worker.recognize(canvas);
                            fullText += text + "\n"; 
                        } else {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            
                            if (strictTable) {
                                // Thu·∫≠t to√°n m·ªõi: Gi·ªØ layout d√≤ng
                                fullText += extractTextWithLayout(textContent);
                            } else {
                                // Thu·∫≠t to√°n c≈©: N·ªëi li·ªÅn
                                fullText += textContent.items.map(item => item.str).join(' ') + " ";
                            }
                        }
                    }

                    // --- X·ª¨ L√ù T√ÅCH C√ÇU / D√íNG ---
                    let sentences = [];
                    if (strictTable || useOCR) {
                        // N·∫øu ch·∫ø ƒë·ªô b·∫£ng: T√°ch b·∫±ng xu·ªëng d√≤ng (\n) HO·∫∂C d·∫•u c√¢u
                        // Regex n√†y gi·ªØ l·∫°i d·∫•u ph√¢n c√°ch
                        sentences = fullText.match(/[^.!?\n]+[.!?\n]+|[^.!?\n]+$/g) || [];
                    } else {
                        // Ch·∫ø ƒë·ªô th∆∞·ªùng: Ch·ªâ t√°ch b·∫±ng d·∫•u c√¢u
                        sentences = fullText.replace(/\s+/g, ' ').match(/[^.!?]+[.!?]+|[^.!?]+$/g) || [];
                    }

                    const cleanSentences = sentences.map(s => s.trim()).filter(s => s.length > 0);
                    const fileResults = [];

                    for (let i = 0; i < cleanSentences.length; i++) {
                        if (cleanSentences[i].toLowerCase().includes(lowerKeyword)) {
                            // L·∫•y 5 d√≤ng/c√¢u tr∆∞·ªõc v√† sau
                            const startIndex = Math.max(0, i - 5);
                            const endIndex = Math.min(cleanSentences.length - 1, i + 5);
                            const contextBlock = cleanSentences.slice(startIndex, endIndex + 1);
                            
                            fileResults.push({
                                content: contextBlock,
                                targetIndex: i - startIndex
                            });
                        }
                    }

                    if (fileResults.length > 0) {
                        totalMatchesGlobal += fileResults.length;
                        resultContainer.classList.remove('hidden');
                        
                        const fileHeader = document.createElement('div');
                        fileHeader.className = "file-header";
                        fileHeader.textContent = `üìÑ File: ${file.name} (${fileResults.length} k·∫øt qu·∫£)`;
                        resultsList.appendChild(fileHeader);

                        fileResults.forEach((res) => {
                            const li = document.createElement('li');
                            li.className = "bg-white p-4 rounded-lg shadow border-l-4 border-gray-300 hover:border-blue-500 transition mb-4 ml-4 overflow-x-auto";
                            
                            // Render n·ªôi dung
                            const htmlContent = res.content.map((line, idx) => {
                                let displayLine = line.replace(/\n/g, ''); // B·ªè k√Ω t·ª± \n th·ª´a ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫πp
                                if (idx === res.targetIndex) {
                                    const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                                    displayLine = displayLine.replace(regex, '<span class="highlight">$1</span>');
                                    return `<div class="bg-blue-50 font-bold py-1">${displayLine}</div>`;
                                }
                                return `<div>${displayLine}</div>`;
                            }).join('');

                            li.innerHTML = `<div class="result-content text-sm text-gray-700">${htmlContent}</div>`;
                            resultsList.appendChild(li);
                        });
                    }
                }

                if (useOCR && worker) await worker.terminate();

                if (totalMatchBadge) totalMatchBadge.textContent = totalMatchesGlobal;
                progressBar.style.width = '100%';
                if (totalMatchesGlobal === 0) statusMsg.innerHTML = '<span class="text-red-500">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.</span>';
                else statusMsg.textContent = 'Ho√†n t·∫•t!';

            } catch (error) {
                console.error(error);
                statusMsg.textContent = 'L·ªói: ' + error.message;
            } finally {
                btnProcess.disabled = false;
                btnProcess.innerHTML = '<span>B·∫Øt ƒê·∫ßu Qu√©t</span>';
            }
        }
    </script>
</body>
</html>
