<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≠ch Xu·∫•t PDF Th√¥ng Minh (ƒêa Ng√¥n Ng·ªØ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        .highlight {
            background-color: #fde047;
            font-weight: bold;
            padding: 0 2px;
            border-radius: 2px;
            color: #000;
            border-bottom: 2px solid #eab308;
        }
        .file-header {
            background-color: #e0f2fe;
            border-left: 4px solid #0284c7;
            padding: 10px;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #0369a1;
            border-radius: 4px;
        }
        .result-content {
            white-space: pre-wrap;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 1em;
            line-height: 1.6;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Tooltip style cho t·ª´ kh√≥a d·ªãch */
        .translated-tag {
            font-size: 0.75rem;
            background-color: #dbeafe;
            color: #1e40af;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">

    <div class="max-w-5xl mx-auto p-6">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-blue-700 mb-2">Tr√≠ch Xu·∫•t PDF ƒêa Ng√¥n Ng·ªØ</h1>
            <p class="text-gray-600">T√¨m ki·∫øm song ng·ªØ (Anh ‚Üî Vi·ªát), h·ªó tr·ª£ b·∫£ng bi·ªÉu v√† OCR</p>
        </header>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">1. Ch·ªçn file PDF (Gi·ªØ Ctrl ƒë·ªÉ ch·ªçn nhi·ªÅu)</label>
                    <input type="file" id="pdfInput" accept=".pdf" multiple
                        class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100 cursor-pointer border border-gray-300 rounded-lg p-1"
                    />
                    <p class="text-xs text-gray-400 mt-1 italic" id="fileCountLabel">Ch∆∞a ch·ªçn file n√†o</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">2. Nh·∫≠p t·ª´ kh√≥a (Ti·∫øng Vi·ªát ho·∫∑c Anh)</label>
                    <input type="text" id="keywordInput" placeholder="VD: H·ª£p ƒë·ªìng, Invoice, Total..." 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    />
                    <div id="translationPreview" class="mt-2 text-sm text-gray-500 min-h-[20px]"></div>
                </div>
            </div>

            <div class="mt-4 flex flex-wrap items-center justify-center gap-6 bg-gray-50 p-3 rounded-lg border border-gray-200">
                <div class="flex items-center" title="D√πng cho file scan, ·∫£nh ch·ª•p">
                    <input type="checkbox" id="useOCR" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                    <label for="useOCR" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer select-none">
                        B·∫≠t OCR (Qu√©t ·∫£nh)
                    </label>
                </div>
                
                <div class="flex items-center" title="C·ªë g·∫Øng gi·ªØ nguy√™n h√†ng c·ªôt c·ªßa b·∫£ng">
                    <input type="checkbox" id="strictTable" checked class="w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500">
                    <label for="strictTable" class="ml-2 text-sm font-medium text-gray-700 cursor-pointer select-none">
                        Ch·∫ø ƒë·ªô B·∫£ng (Gi·ªØ c·∫•u tr√∫c)
                    </label>
                </div>

                <div class="flex items-center border-l pl-6 border-gray-300" title="T·ª± ƒë·ªông d·ªãch t·ª´ kh√≥a sang ng√¥n ng·ªØ c√≤n l·∫°i">
                    <input type="checkbox" id="autoTranslate" checked class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                    <label for="autoTranslate" class="ml-2 text-sm font-bold text-purple-700 cursor-pointer select-none flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                        </svg>
                        D·ªãch t·ª± ƒë·ªông (Anh ‚Üî Vi·ªát)
                    </label>
                </div>
            </div>

            <div class="mt-6 text-center">
                <button onclick="processPDFs()" id="btnProcess"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-lg transition duration-200 flex items-center justify-center mx-auto space-x-2 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <span>B·∫Øt ƒê·∫ßu T√¨m Ki·∫øm</span>
                </button>
            </div>
            
            <div id="progressContainer" class="hidden mt-4 w-full bg-gray-200 rounded-full h-2.5">
                <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div id="statusMessage" class="mt-2 text-center text-sm text-gray-500 hidden font-medium"></div>
        </div>

        <div id="resultContainer" class="hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                K·∫øt qu·∫£ t√¨m ki·∫øm
                <span id="activeKeywordsBadge" class="ml-3 text-sm font-normal text-gray-500"></span>
                <span id="totalMatchCount" class="ml-auto bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full">0</span>
            </h2>
            <ul id="resultsList" class="space-y-4 pb-10"></ul>
        </div>
    </div>

    <script>
        document.getElementById('pdfInput').addEventListener('change', function() {
            const count = this.files.length;
            document.getElementById('fileCountLabel').textContent = count > 0 ? `ƒê√£ ch·ªçn ${count} file` : 'Ch∆∞a ch·ªçn file n√†o';
        });

        // H√†m h·ªó tr·ª£: Escape Regex
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // H√†m D·ªãch Thu·∫≠t (S·ª≠ d·ª•ng API MyMemory mi·ªÖn ph√≠)
        async function translateKeyword(text) {
            // Logic ph√°t hi·ªán ng√¥n ng·ªØ d·ª±a tr√™n k√Ω t·ª± c√≥ d·∫•u
            const isVietnamese = /[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/i.test(text);
            
            // N·∫øu l√† Ti·∫øng Vi·ªát -> D·ªãch sang Anh. N·∫øu kh√¥ng (coi l√† Anh) -> D·ªãch sang Vi·ªát
            const langPair = isVietnamese ? 'vi|en' : 'en|vi';
            const detectedLabel = isVietnamese ? 'Ph√°t hi·ªán Ti·∫øng Vi·ªát ‚ûù D·ªãch sang Anh' : 'Ph√°t hi·ªán Ti·∫øng Anh ‚ûù D·ªãch sang Vi·ªát';

            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${langPair}`);
                const data = await response.json();
                
                if (data && data.responseData && data.responseData.translatedText) {
                    // API n√†y ƒë√¥i khi tr·∫£ v·ªÅ l·ªói trong text n·∫øu qu√° limit, ki·ªÉm tra s∆° b·ªô
                    if (data.responseData.translatedText.includes("MYMEMORY WARNING")) {
                        console.warn("Translation limit reached or error");
                        return { text: null, label: detectedLabel };
                    }
                    return { text: data.responseData.translatedText, label: detectedLabel };
                }
            } catch (error) {
                console.error("L·ªói d·ªãch thu·∫≠t:", error);
                return { text: null, label: detectedLabel };
            }
            return { text: null, label: detectedLabel };
        }

        // H√†m s·∫Øp x·∫øp text items ƒë·ªÉ t√°i t·∫°o d√≤ng (cho b·∫£ng)
        function extractTextWithLayout(textContent) {
            const items = textContent.items;
            if (items.length === 0) return "";

            items.sort((a, b) => {
                const yDiff = Math.abs(a.transform[5] - b.transform[5]);
                if (yDiff < 4) { 
                    return a.transform[4] - b.transform[4]; 
                }
                return b.transform[5] - a.transform[5]; 
            });

            let text = "";
            let lastY = -1;
            
            for (const item of items) {
                if (lastY !== -1 && Math.abs(item.transform[5] - lastY) > 5) {
                    text += "\n"; 
                } else if (lastY !== -1) {
                    text += "   "; 
                }
                text += item.str;
                lastY = item.transform[5];
            }
            return text + "\n"; 
        }

        async function processPDFs() {
            const fileInput = document.getElementById('pdfInput');
            const keywordInput = document.getElementById('keywordInput');
            const useOCR = document.getElementById('useOCR').checked;
            const strictTable = document.getElementById('strictTable').checked;
            const autoTranslate = document.getElementById('autoTranslate').checked;
            
            const statusMsg = document.getElementById('statusMessage');
            const resultsList = document.getElementById('resultsList');
            const resultContainer = document.getElementById('resultContainer');
            const btnProcess = document.getElementById('btnProcess');
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('progressContainer');
            const totalMatchBadge = document.getElementById('totalMatchCount');
            const activeKeywordsBadge = document.getElementById('activeKeywordsBadge');
            const translationPreview = document.getElementById('translationPreview');

            // Reset UI
            resultsList.innerHTML = '';
            resultContainer.classList.add('hidden');
            progressContainer.classList.add('hidden');
            progressBar.style.width = '0%';
            statusMsg.classList.remove('hidden');
            statusMsg.innerHTML = '';
            translationPreview.innerHTML = '';
            let totalMatchesGlobal = 0;

            if (fileInput.files.length === 0) { alert('Vui l√≤ng ch·ªçn file PDF.'); return; }
            const originalKeyword = keywordInput.value.trim();
            if (!originalKeyword) { alert('Vui l√≤ng nh·∫≠p t·ª´ kh√≥a.'); return; }

            btnProcess.disabled = true;
            btnProcess.innerHTML = '<div class="loader"></div><span class="ml-2">ƒêang x·ª≠ l√Ω...</span>';
            progressContainer.classList.remove('hidden');

            // --- B∆Ø·ªöC 1: X·ª≠ l√Ω t·ª´ kh√≥a (D·ªãch) ---
            let searchKeywords = [originalKeyword]; // M·∫£ng ch·ª©a c√°c t·ª´ kh√≥a c·∫ßn t√¨m
            
            if (autoTranslate) {
                statusMsg.textContent = "ƒêang d·ªãch t·ª´ kh√≥a...";
                
                const transResult = await translateKeyword(originalKeyword);
                const translated = transResult.text;
                const label = transResult.label;

                if (translated && translated.toLowerCase() !== originalKeyword.toLowerCase()) {
                    searchKeywords.push(translated);
                    // Hi·ªÉn th·ªã tr·∫°ng th√°i r√µ r√†ng cho ng∆∞·ªùi d√πng
                    translationPreview.innerHTML = `
                        <div class="flex items-center text-blue-700 bg-blue-50 p-2 rounded border border-blue-200">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span>${label}: <b>"${translated}"</b></span>
                        </div>`;
                } else {
                    translationPreview.innerHTML = `<span class="text-gray-500 italic">Kh√¥ng t√¨m th·∫•y b·∫£n d·ªãch kh√°c bi·ªát ho·∫∑c l·ªói k·∫øt n·ªëi. Ch·ªâ t√¨m: "${originalKeyword}"</span>`;
                }
            } else {
                translationPreview.innerHTML = `ƒêang t√¨m ch√≠nh x√°c: <b>"${originalKeyword}"</b>`;
            }

            // Hi·ªÉn th·ªã danh s√°ch t·ª´ kh√≥a l√™n UI
            activeKeywordsBadge.textContent = `(ƒêang t√¨m: ${searchKeywords.join(', ')})`;

            // Chu·∫©n b·ªã Regex ƒë·ªÉ highlight t·∫•t c·∫£ c√°c t·ª´ kh√≥a
            // S·∫Øp x·∫øp t·ª´ d√†i ƒë·∫øn ng·∫Øn ƒë·ªÉ highlight ƒë√∫ng (tr√°nh tr∆∞·ªùng h·ª£p t·ª´ ng·∫Øn n·∫±m trong t·ª´ d√†i)
            const sortedKeywords = [...searchKeywords].sort((a, b) => b.length - a.length);
            const regexPattern = sortedKeywords.map(k => escapeRegExp(k)).join('|');
            const highlightRegex = new RegExp(`(${regexPattern})`, 'gi');
            
            // Chu·∫©n b·ªã danh s√°ch t·ª´ kh√≥a ch·ªØ th∆∞·ªùng ƒë·ªÉ so s√°nh
            const lowerKeywords = searchKeywords.map(k => k.toLowerCase());

            // --- B∆Ø·ªöC 2: Kh·ªüi t·∫°o OCR (N·∫øu c·∫ßn) ---
            let worker = null;
            if (useOCR) {
                statusMsg.textContent = 'ƒêang kh·ªüi ƒë·ªông OCR engine...';
                try {
                    worker = await Tesseract.createWorker('vie'); // ∆Øu ti√™n ti·∫øng Vi·ªát
                } catch (e) {
                    alert("L·ªói t·∫£i th∆∞ vi·ªán OCR. Ki·ªÉm tra m·∫°ng.");
                    btnProcess.disabled = false;
                    return;
                }
            }

            try {
                const files = Array.from(fileInput.files);
                
                for (let fIndex = 0; fIndex < files.length; fIndex++) {
                    const file = files[fIndex];
                    let fullText = "";
                    
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    const totalPages = pdf.numPages;

                    for (let i = 1; i <= totalPages; i++) {
                        // C·∫≠p nh·∫≠t Progress Bar
                        const progress = ((fIndex + (i / totalPages)) / files.length) * 100;
                        progressBar.style.width = `${progress}%`;
                        statusMsg.textContent = `ƒêang qu√©t: ${file.name} (Trang ${i}/${totalPages})`;

                        if (useOCR) {
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height; canvas.width = viewport.width;
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            
                            const { data: { text } } = await worker.recognize(canvas);
                            fullText += text + "\n"; 
                        } else {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            
                            if (strictTable) {
                                fullText += extractTextWithLayout(textContent);
                            } else {
                                fullText += textContent.items.map(item => item.str).join(' ') + " ";
                            }
                        }
                    }

                    // --- B∆Ø·ªöC 3: Ph√¢n t√≠ch & T√¨m ki·∫øm ---
                    let sentences = [];
                    // T√°ch c√¢u d·ª±a tr√™n ch·∫ø ƒë·ªô
                    if (strictTable || useOCR) {
                        sentences = fullText.match(/[^.!?\n]+[.!?\n]+|[^.!?\n]+$/g) || [];
                    } else {
                        sentences = fullText.replace(/\s+/g, ' ').match(/[^.!?]+[.!?]+|[^.!?]+$/g) || [];
                    }

                    const cleanSentences = sentences.map(s => s.trim()).filter(s => s.length > 0);
                    const fileResults = [];

                    for (let i = 0; i < cleanSentences.length; i++) {
                        const currentSentenceLower = cleanSentences[i].toLowerCase();
                        
                        // Ki·ªÉm tra xem c√¢u hi·ªán t·∫°i c√≥ ch·ª©a B·∫§T K·ª≤ t·ª´ kh√≥a n√†o kh√¥ng
                        const isMatch = lowerKeywords.some(kw => currentSentenceLower.includes(kw));

                        if (isMatch) {
                            // L·∫•y ng·ªØ c·∫£nh (context)
                            const startIndex = Math.max(0, i - 5);
                            const endIndex = Math.min(cleanSentences.length - 1, i + 5);
                            const contextBlock = cleanSentences.slice(startIndex, endIndex + 1);
                            
                            fileResults.push({
                                content: contextBlock,
                                targetIndex: i - startIndex
                            });
                        }
                    }

                    // --- B∆Ø·ªöC 4: Hi·ªÉn th·ªã k·∫øt qu·∫£ ---
                    if (fileResults.length > 0) {
                        totalMatchesGlobal += fileResults.length;
                        resultContainer.classList.remove('hidden');
                        
                        const fileHeader = document.createElement('div');
                        fileHeader.className = "file-header";
                        fileHeader.innerHTML = `
                            <div class="flex justify-between items-center">
                                <span>üìÑ File: ${file.name}</span>
                                <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded">${fileResults.length} k·∫øt qu·∫£</span>
                            </div>`;
                        resultsList.appendChild(fileHeader);

                        fileResults.forEach((res) => {
                            const li = document.createElement('li');
                            li.className = "bg-white p-4 rounded-lg shadow border-l-4 border-gray-300 hover:border-blue-500 transition mb-4 ml-4 overflow-x-auto";
                            
                            // Render n·ªôi dung
                            const htmlContent = res.content.map((line, idx) => {
                                let displayLine = line.replace(/\n/g, ''); 
                                
                                // Logic Highlight M·ªõi: T√¨m v√† highlight t·∫•t c·∫£ c√°c t·ª´ kh√≥a
                                displayLine = displayLine.replace(highlightRegex, match => `<span class="highlight">${match}</span>`);

                                if (idx === res.targetIndex) {
                                    return `<div class="bg-blue-50 py-1 pl-2 border-l-2 border-blue-300">${displayLine}</div>`;
                                }
                                return `<div class="pl-2 opacity-80">${displayLine}</div>`;
                            }).join('');

                            li.innerHTML = `<div class="result-content text-sm text-gray-700">${htmlContent}</div>`;
                            resultsList.appendChild(li);
                        });
                    }
                }

                if (useOCR && worker) await worker.terminate();

                if (totalMatchBadge) totalMatchBadge.textContent = totalMatchesGlobal;
                progressBar.style.width = '100%';
                
                if (totalMatchesGlobal === 0) {
                    statusMsg.innerHTML = `<span class="text-red-500 font-bold">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o cho: "${searchKeywords.join('" ho·∫∑c "')}"</span>`;
                } else {
                    statusMsg.className = "mt-2 text-center text-sm text-green-600 font-bold";
                    statusMsg.textContent = 'Ho√†n t·∫•t qu√° tr√¨nh t√¨m ki·∫øm!';
                }

            } catch (error) {
                console.error(error);
                statusMsg.className = "mt-2 text-center text-sm text-red-600 font-bold";
                statusMsg.textContent = 'L·ªói nghi√™m tr·ªçng: ' + error.message;
            } finally {
                btnProcess.disabled = false;
                btnProcess.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <span>B·∫Øt ƒê·∫ßu T√¨m Ki·∫øm</span>`;
            }
        }
    </script>
</body>
</html>
