<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≠ch Xu·∫•t PDF Theo Tab (ƒêa Ng√¥n Ng·ªØ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        .highlight {
            background-color: #fde047;
            font-weight: bold;
            padding: 0 2px;
            border-radius: 2px;
            color: #000;
            border-bottom: 2px solid #eab308;
        }
        .file-header {
            background-color: #e0f2fe;
            border-left: 4px solid #0284c7;
            padding: 10px;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #0369a1;
            border-radius: 4px;
        }
        .result-content {
            white-space: pre-wrap;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 1em;
            line-height: 1.6;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Tab Styles */
        .tab-btn {
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
            background-color: #eff6ff;
        }
        .tab-btn:hover:not(.active) {
            background-color: #f3f4f6;
            color: #374151;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800">

    <div class="max-w-6xl mx-auto p-4 md:p-6">
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-blue-700 mb-2">Tr√≠ch Xu·∫•t PDF ƒêa Tab</h1>
            <p class="text-gray-600">T√¨m ki·∫øm song ng·ªØ, OCR v√† qu·∫£n l√Ω k·∫øt qu·∫£ theo t·ª´ng Tab ri√™ng bi·ªát</p>
        </header>

        <!-- INPUT AREA -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6 border border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">1. Ch·ªçn file PDF (Gi·ªØ Ctrl ƒë·ªÉ ch·ªçn nhi·ªÅu)</label>
                    <input type="file" id="pdfInput" accept=".pdf" multiple
                        class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100 cursor-pointer border border-gray-300 rounded-lg p-1"
                    />
                    <p class="text-xs text-gray-400 mt-1 italic" id="fileCountLabel">Ch∆∞a ch·ªçn file n√†o</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">2. Nh·∫≠p t·ª´ kh√≥a m·ªõi</label>
                    <div class="flex gap-2">
                        <input type="text" id="keywordInput" placeholder="Nh·∫≠p t·ª´ kh√≥a..." 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            onkeypress="if(event.key === 'Enter') processPDFs()"
                        />
                        <button onclick="processPDFs()" id="btnProcess"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow flex items-center whitespace-nowrap">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            T√¨m Ki·∫øm
                        </button>
                    </div>
                </div>
            </div>

            <!-- Options -->
            <div class="mt-4 flex flex-wrap items-center gap-4 text-sm">
                <div class="flex items-center mr-4">
                    <input type="checkbox" id="useOCR" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <label for="useOCR" class="ml-2 text-gray-700 cursor-pointer">B·∫≠t OCR (Qu√©t ·∫£nh)</label>
                </div>
                
                <div class="flex items-center mr-4">
                    <input type="checkbox" id="strictTable" checked class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                    <label for="strictTable" class="ml-2 text-gray-700 cursor-pointer">Ch·∫ø ƒë·ªô B·∫£ng (Gi·ªØ c·∫•u tr√∫c)</label>
                </div>

                <!-- T√°ch bi·ªát t√πy ch·ªçn d·ªãch -->
                <div class="flex items-center border-l pl-4 border-gray-300">
                    <input type="checkbox" id="translateViEn" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                    <label for="translateViEn" class="ml-2 font-medium text-purple-700 cursor-pointer">D·ªãch Vi·ªát ‚ûù Anh</label>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="translateEnVi" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                    <label for="translateEnVi" class="ml-2 font-medium text-purple-700 cursor-pointer">D·ªãch Anh ‚ûù Vi·ªát</label>
                </div>
            </div>

            <!-- Global Progress Bar (Shows when ANY search is running) -->
            <div id="globalProgressContainer" class="hidden mt-4 w-full bg-gray-200 rounded-full h-1.5">
                <div id="globalProgressBar" class="bg-blue-600 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- TABS CONTAINER -->
        <div id="mainTabsContainer" class="hidden">
            <!-- Tab Navigation -->
            <div class="flex overflow-x-auto border-b border-gray-200 mb-4 no-scrollbar" id="tabsNav">
                <!-- Tabs will be injected here -->
            </div>

            <!-- Tab Contents -->
            <div id="tabsContentArea">
                <!-- Content will be injected here -->
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-10 text-gray-400">
            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
            <p>K·∫øt qu·∫£ t√¨m ki·∫øm s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y</p>
        </div>

    </div>

    <script>
        // --- GLOBAL VARIABLES & HELPERS ---
        let searchIdCounter = 0;
        let isProcessing = false;

        document.getElementById('pdfInput').addEventListener('change', function() {
            const count = this.files.length;
            document.getElementById('fileCountLabel').textContent = count > 0 ? `ƒê√£ ch·ªçn ${count} file` : 'Ch∆∞a ch·ªçn file n√†o';
        });

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // --- TRANSLATION LOGIC ---
        // langPair: 'vi|en' ho·∫∑c 'en|vi'
        async function translateKeyword(text, langPair) {
            const detectedLabel = langPair === 'vi|en' ? 'Vi·ªát ‚ûù Anh' : 'Anh ‚ûù Vi·ªát';

            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${langPair}`);
                const data = await response.json();
                
                if (data && data.responseData && data.responseData.translatedText) {
                    if (data.responseData.translatedText.includes("MYMEMORY WARNING")) {
                        return { text: null, label: detectedLabel };
                    }
                    return { text: data.responseData.translatedText, label: detectedLabel };
                }
            } catch (error) {
                console.error("L·ªói d·ªãch:", error);
            }
            return { text: null, label: detectedLabel };
        }

        // --- TEXT EXTRACTION HELPER ---
        function extractTextWithLayout(textContent) {
            const items = textContent.items;
            if (items.length === 0) return "";
            items.sort((a, b) => {
                const yDiff = Math.abs(a.transform[5] - b.transform[5]);
                return yDiff < 4 ? a.transform[4] - b.transform[4] : b.transform[5] - a.transform[5];
            });
            let text = "";
            let lastY = -1;
            for (const item of items) {
                if (lastY !== -1 && Math.abs(item.transform[5] - lastY) > 5) text += "\n";
                else if (lastY !== -1) text += "   ";
                text += item.str;
                lastY = item.transform[5];
            }
            return text + "\n";
        }

        // --- TAB MANAGEMENT LOGIC ---
        // translatedInfos is now an Array of objects {text, label}
        function createNewTab(keyword, translatedInfos) {
            searchIdCounter++;
            const tabId = `tab-${searchIdCounter}`;
            
            // 1. Hide empty state
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('mainTabsContainer').classList.remove('hidden');

            // 2. Create Tab Button
            const tabBtn = document.createElement('button');
            tabBtn.className = 'tab-btn flex items-center px-4 py-2 mr-2 text-sm font-medium text-gray-500 bg-white border border-transparent rounded-t-lg hover:text-gray-700 hover:border-gray-300 focus:outline-none';
            tabBtn.dataset.target = tabId;
            tabBtn.innerHTML = `
                <span class="max-w-[100px] truncate" title="${keyword}">${keyword}</span>
                <span class="ml-2 text-xs bg-gray-200 text-gray-600 rounded-full px-1.5 py-0.5" id="badge-${tabId}">...</span>
                <span class="ml-2 text-gray-400 hover:text-red-500 rounded-full p-0.5" onclick="closeTab('${tabId}', event)">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </span>
            `;
            tabBtn.onclick = (e) => switchTab(tabId);
            document.getElementById('tabsNav').appendChild(tabBtn);

            // 3. Create Tab Content Container
            const contentDiv = document.createElement('div');
            contentDiv.id = tabId;
            contentDiv.className = 'tab-content';
            
            // Translation info block
            let transHtml = '';
            if (translatedInfos && translatedInfos.length > 0) {
                const badges = translatedInfos.map(info => `
                    <div class="mr-2 mb-1 bg-blue-50 text-blue-800 text-xs px-3 py-1 rounded border border-blue-100 inline-block">
                        <span class="font-bold">${info.label}:</span> "${keyword}" ‚Üî "${info.text}"
                    </div>
                `).join('');
                
                transHtml = `<div class="mb-3 flex flex-wrap">${badges}</div>`;
            }

            contentDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">K·∫øt qu·∫£ cho: <span class="text-blue-600">"${keyword}"</span></h2>
                    <div id="status-${tabId}" class="text-sm font-medium text-orange-500 flex items-center">
                        <div class="loader mr-2"></div> ƒêang kh·ªüi t·∫°o...
                    </div>
                </div>
                ${transHtml}
                <ul id="list-${tabId}" class="space-y-4 pb-10 min-h-[200px]"></ul>
            `;
            document.getElementById('tabsContentArea').appendChild(contentDiv);

            // 4. Activate new tab
            switchTab(tabId);

            return tabId;
        }

        function switchTab(tabId) {
            // Remove active class from all buttons and contents
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Activate target
            const btn = document.querySelector(`.tab-btn[data-target="${tabId}"]`);
            const content = document.getElementById(tabId);
            
            if (btn && content) {
                btn.classList.add('active');
                content.classList.add('active');
            }
        }

        function closeTab(tabId, event) {
            event.stopPropagation(); // Prevent switching to tab when clicking close
            const btn = document.querySelector(`.tab-btn[data-target="${tabId}"]`);
            const content = document.getElementById(tabId);
            
            if (btn) btn.remove();
            if (content) content.remove();

            // If we closed the active tab, switch to the last available one
            if (!document.querySelector('.tab-btn.active')) {
                const remainingBtns = document.querySelectorAll('.tab-btn');
                if (remainingBtns.length > 0) {
                    switchTab(remainingBtns[remainingBtns.length - 1].dataset.target);
                } else {
                    document.getElementById('mainTabsContainer').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');
                }
            }
        }

        // --- MAIN PROCESSING LOGIC ---
        async function processPDFs() {
            const fileInput = document.getElementById('pdfInput');
            const keywordInput = document.getElementById('keywordInput');
            const useOCR = document.getElementById('useOCR').checked;
            const strictTable = document.getElementById('strictTable').checked;
            
            // New checkbox inputs
            const useViEn = document.getElementById('translateViEn').checked;
            const useEnVi = document.getElementById('translateEnVi').checked;

            const globalProgressBar = document.getElementById('globalProgressBar');
            const globalProgressContainer = document.getElementById('globalProgressContainer');

            const originalKeyword = keywordInput.value.trim();
            if (fileInput.files.length === 0) { alert('Vui l√≤ng ch·ªçn file PDF.'); return; }
            if (!originalKeyword) { alert('Vui l√≤ng nh·∫≠p t·ª´ kh√≥a.'); return; }

            // Start UI Feedback
            isProcessing = true;
            document.getElementById('btnProcess').disabled = true;
            document.getElementById('btnProcess').classList.add('opacity-50', 'cursor-not-allowed');
            globalProgressContainer.classList.remove('hidden');
            globalProgressBar.style.width = '5%';

            // Prepare Keywords
            let searchKeywords = [originalKeyword];
            let translatedInfos = [];

            // Explicit Translation Logic
            if (useViEn) {
                const transResult = await translateKeyword(originalKeyword, 'vi|en');
                if (transResult.text && transResult.text.toLowerCase() !== originalKeyword.toLowerCase()) {
                    searchKeywords.push(transResult.text);
                    translatedInfos.push(transResult);
                }
            }
            if (useEnVi) {
                const transResult = await translateKeyword(originalKeyword, 'en|vi');
                if (transResult.text && transResult.text.toLowerCase() !== originalKeyword.toLowerCase()) {
                    // Avoid duplicates if both directions yield same word (rare but possible)
                    if (!searchKeywords.includes(transResult.text)) {
                        searchKeywords.push(transResult.text);
                        translatedInfos.push(transResult);
                    }
                }
            }

            // CREATE NEW TAB
            const tabId = createNewTab(originalKeyword, translatedInfos);
            const tabStatus = document.getElementById(`status-${tabId}`);
            const tabList = document.getElementById(`list-${tabId}`);
            const tabBadge = document.getElementById(`badge-${tabId}`);

            // Prepare Regex
            const sortedKeywords = [...searchKeywords].sort((a, b) => b.length - a.length);
            const regexPattern = sortedKeywords.map(k => escapeRegExp(k)).join('|');
            const highlightRegex = new RegExp(`(${regexPattern})`, 'gi');
            const lowerKeywords = searchKeywords.map(k => k.toLowerCase());

            // Initialize OCR if needed
            let worker = null;
            if (useOCR) {
                tabStatus.textContent = "ƒêang t·∫£i OCR Engine...";
                try {
                    worker = await Tesseract.createWorker('vie');
                } catch (e) {
                    tabStatus.innerHTML = `<span class="text-red-500">L·ªói OCR: ${e.message}</span>`;
                    cleanup();
                    return;
                }
            }

            try {
                const files = Array.from(fileInput.files);
                let totalMatchesInTab = 0;
                
                for (let fIndex = 0; fIndex < files.length; fIndex++) {
                    const file = files[fIndex];
                    let fullText = "";
                    
                    // Update Status
                    tabStatus.innerHTML = `<div class="loader mr-2"></div> ƒêang qu√©t: ${file.name} (${fIndex + 1}/${files.length})`;

                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    const totalPages = pdf.numPages;

                    for (let i = 1; i <= totalPages; i++) {
                        // Update Progress
                        const progress = ((fIndex + (i / totalPages)) / files.length) * 100;
                        globalProgressBar.style.width = `${progress}%`;

                        if (useOCR) {
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height; canvas.width = viewport.width;
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            const { data: { text } } = await worker.recognize(canvas);
                            fullText += text + "\n"; 
                        } else {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            if (strictTable) {
                                fullText += extractTextWithLayout(textContent);
                            } else {
                                fullText += textContent.items.map(item => item.str).join(' ') + " ";
                            }
                        }
                    }

                    // --- SEARCH LOGIC ---
                    let sentences = [];
                    if (strictTable || useOCR) {
                        sentences = fullText.match(/[^.!?\n]+[.!?\n]+|[^.!?\n]+$/g) || [];
                    } else {
                        sentences = fullText.replace(/\s+/g, ' ').match(/[^.!?]+[.!?]+|[^.!?]+$/g) || [];
                    }

                    const cleanSentences = sentences.map(s => s.trim()).filter(s => s.length > 0);
                    const fileResults = [];

                    for (let sIdx = 0; sIdx < cleanSentences.length; sIdx++) {
                        const currentSentenceLower = cleanSentences[sIdx].toLowerCase();
                        if (lowerKeywords.some(kw => currentSentenceLower.includes(kw))) {
                            const startIndex = Math.max(0, sIdx - 3); // Context context -3 to +3
                            const endIndex = Math.min(cleanSentences.length - 1, sIdx + 3);
                            const contextBlock = cleanSentences.slice(startIndex, endIndex + 1);
                            fileResults.push({ content: contextBlock, targetIndex: sIdx - startIndex });
                        }
                    }

                    // --- APPEND RESULTS TO TAB ---
                    if (fileResults.length > 0) {
                        totalMatchesInTab += fileResults.length;
                        
                        const fileHeader = document.createElement('div');
                        fileHeader.className = "file-header";
                        fileHeader.innerHTML = `
                            <div class="flex justify-between items-center">
                                <span>üìÑ File: ${file.name}</span>
                                <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded">${fileResults.length} k·∫øt qu·∫£</span>
                            </div>`;
                        tabList.appendChild(fileHeader);

                        fileResults.forEach((res) => {
                            const li = document.createElement('li');
                            li.className = "bg-white p-4 rounded-lg shadow border-l-4 border-gray-300 hover:border-blue-500 transition mb-4 ml-4 overflow-x-auto";
                            
                            const htmlContent = res.content.map((line, idx) => {
                                let displayLine = line.replace(/\n/g, ''); 
                                displayLine = displayLine.replace(highlightRegex, match => `<span class="highlight">${match}</span>`);
                                if (idx === res.targetIndex) {
                                    return `<div class="bg-blue-50 py-1 pl-2 border-l-2 border-blue-300 font-medium text-gray-900">${displayLine}</div>`;
                                }
                                return `<div class="pl-2 opacity-70 text-gray-600">${displayLine}</div>`;
                            }).join('');

                            li.innerHTML = `<div class="result-content text-sm">${htmlContent}</div>`;
                            tabList.appendChild(li);
                        });
                    }
                }

                // Finalize Tab State
                if (totalMatchesInTab === 0) {
                    tabStatus.className = "text-sm font-bold text-red-500";
                    tabStatus.textContent = "Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o.";
                    tabList.innerHTML = `<div class="text-center text-gray-400 italic mt-10">Kh√¥ng c√≥ d·ªØ li·ªáu tr√πng kh·ªõp trong c√°c file ƒë√£ ch·ªçn.</div>`;
                } else {
                    tabStatus.className = "text-sm font-bold text-green-600";
                    tabStatus.textContent = `Ho√†n t·∫•t! T√¨m th·∫•y ${totalMatchesInTab} k·∫øt qu·∫£.`;
                }
                tabBadge.textContent = totalMatchesInTab;
                tabBadge.className = `ml-2 text-xs px-1.5 py-0.5 rounded-full text-white ${totalMatchesInTab > 0 ? 'bg-red-500' : 'bg-gray-400'}`;

            } catch (error) {
                console.error(error);
                tabStatus.className = "text-sm font-bold text-red-600";
                tabStatus.textContent = 'L·ªói: ' + error.message;
            } finally {
                if (worker) await worker.terminate();
                cleanup();
            }
        }

        function cleanup() {
            isProcessing = false;
            document.getElementById('btnProcess').disabled = false;
            document.getElementById('btnProcess').classList.remove('opacity-50', 'cursor-not-allowed');
            document.getElementById('globalProgressBar').style.width = '0%';
            setTimeout(() => {
                if(!isProcessing) document.getElementById('globalProgressContainer').classList.add('hidden');
            }, 1000);
        }
    </script>
</body>
</html>
