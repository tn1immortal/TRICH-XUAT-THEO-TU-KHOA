<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√¨m Ki·∫øm ƒêa ƒê·ªãnh D·∫°ng: PDF, Word, Excel...</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF.js (ƒê·ªçc PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Tesseract.js (OCR H√¨nh ·∫£nh) -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <!-- Mammoth.js (ƒê·ªçc DOCX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <!-- SheetJS (ƒê·ªçc Excel/CSV) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        .highlight {
            background-color: #fde047;
            font-weight: bold;
            padding: 0 2px;
            border-radius: 2px;
            color: #000;
            border-bottom: 2px solid #eab308;
        }
        .file-header {
            background-color: #e0f2fe;
            border-left: 4px solid #0284c7;
            padding: 10px;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #0369a1;
            border-radius: 4px;
        }
        .result-content {
            white-space: pre-wrap;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 1em;
            line-height: 1.6;
            color: #334155;
        }
        .full-content-view {
            white-space: pre-wrap;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 0.95em;
            line-height: 1.6;
            background-color: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            margin-top: 10px;
            color: #1e293b;
            max-height: 500px;
            overflow-y: auto;
            position: relative;
        }
        .page-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #e2e8f0;
            color: #64748b;
            font-size: 0.7em;
            padding: 2px 8px;
            border-bottom-left-radius: 6px;
            border-top-right-radius: 6px;
        }
        .translation-block {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #cbd5e1;
            font-size: 0.9em;
            color: #475569;
            background-color: #f8fafc;
            padding: 8px;
            border-radius: 4px;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        .mini-loader {
            width: 14px;
            height: 14px;
            border-width: 2px;
            border-top-color: #64748b;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Tab Styles */
        .tab-btn { transition: all 0.3s ease; }
        .tab-btn.active { border-bottom: 2px solid #2563eb; color: #2563eb; background-color: #eff6ff; }
        .tab-btn:hover:not(.active) { background-color: #f3f4f6; color: #374151; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Modal Styles */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
        
        /* Type Badge */
        .type-badge {
            font-size: 0.65em;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 6px;
            text-transform: uppercase;
            font-weight: bold;
        }
        .type-pdf { background-color: #fee2e2; color: #991b1b; }
        .type-docx { background-color: #dbeafe; color: #1e40af; }
        .type-xlsx { background-color: #dcfce7; color: #166534; }
        .type-txt { background-color: #f3f4f6; color: #374151; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800 relative">

    <div class="max-w-6xl mx-auto p-4 md:p-6">
        <header class="mb-6 text-center relative">
            <h1 class="text-3xl font-bold text-blue-700 mb-2">T√¨m Ki·∫øm ƒêa ƒê·ªãnh D·∫°ng</h1>
            <p class="text-gray-600">H·ªó tr·ª£: PDF, Word (docx), Excel (xlsx), Text, HTML</p>
            
            <!-- Bookmark Button -->
            <button onclick="toggleBookmarkModal()" class="absolute top-0 right-0 mt-2 md:mt-0 text-yellow-600 hover:text-yellow-700 font-medium flex items-center bg-yellow-50 hover:bg-yellow-100 px-3 py-1 rounded border border-yellow-200 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                </svg>
                Bookmarks
            </button>
        </header>

        <!-- INPUT AREA -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6 border border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Column 1: File Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">1. Ch·ªçn file t√†i li·ªáu:</label>
                    
                    <!-- DRAG & DROP ZONE -->
                    <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-blue-50 hover:border-blue-400 transition cursor-pointer mb-3 relative bg-gray-50 group">
                        <input type="file" id="fileInput" accept=".pdf,.docx,.xlsx,.xls,.csv,.txt,.html,.htm,.xml,.json" multiple 
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" 
                        />
                        
                        <div class="flex flex-col items-center justify-center pointer-events-none">
                            <svg class="w-10 h-10 text-gray-400 group-hover:text-blue-500 mb-2 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <p class="text-sm text-gray-600 group-hover:text-blue-600 font-medium">K√©o th·∫£ PDF, Word, Excel... v√†o ƒë√¢y</p>
                            <p class="text-xs text-gray-400 mt-1" id="fileCountLabel">Ch∆∞a ch·ªçn file n√†o</p>
                        </div>
                    </div>
                    
                    <!-- URL Input -->
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                        </div>
                        <input type="text" id="urlInput" list="urlHistoryList" placeholder="D√°n Link Online (Web/Drive) ho·∫∑c Path..." 
                            class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            onkeypress="if(event.key === 'Enter') processFiles()"
                        />
                        <datalist id="urlHistoryList"></datalist>
                    </div>
                    <div class="flex justify-between mt-1">
                        <span class="text-xs text-gray-400">H·ªó tr·ª£: PDF, DOCX, XLSX, TXT...</span>
                        <button onclick="clearHistory('url')" class="text-xs text-red-300 hover:text-red-500">X√≥a l·ªãch s·ª≠</button>
                    </div>
                </div>

                <!-- Column 2: Keywords & Options -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700">2. Nh·∫≠p t·ª´ kh√≥a</label>
                        <button onclick="clearHistory('keyword')" class="text-xs text-red-300 hover:text-red-500">X√≥a l·ªãch s·ª≠</button>
                    </div>
                    
                    <div class="flex flex-col gap-2">
                        <div class="relative">
                             <input type="text" id="keywordInput" list="keywordHistoryList" placeholder="Nh·∫≠p t·ª´ kh√≥a..." 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                onkeypress="if(event.key === 'Enter') processFiles()"
                            />
                            <datalist id="keywordHistoryList"></datalist>
                        </div>

                        <div class="flex gap-2">
                            <select id="searchMode" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                                <option value="relative" selected>üîç T∆∞∆°ng ƒë·ªëi</option>
                                <option value="exact">üéØ Ch√≠nh x√°c</option>
                                <option value="smart">üß† Th√¥ng minh</option>
                            </select>

                            <button onclick="processFiles()" id="btnProcess"
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow flex items-center justify-center whitespace-nowrap">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                T√¨m ngay
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Options -->
            <div class="mt-4 flex flex-wrap items-center gap-4 text-sm">
                <div class="flex items-center mr-4">
                    <input type="checkbox" id="useOCR" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                    <label for="useOCR" class="ml-2 text-gray-700 cursor-pointer">OCR (PDF qu√©t ·∫£nh)</label>
                </div>
                <div class="flex items-center mr-4">
                    <input type="checkbox" id="strictTable" checked class="w-4 h-4 text-green-600 rounded focus:ring-green-500">
                    <label for="strictTable" class="ml-2 text-gray-700 cursor-pointer">Gi·ªØ c·∫•u tr√∫c b·∫£ng</label>
                </div>
                <div class="flex items-center border-l pl-4 border-gray-300">
                    <input type="checkbox" id="translateViEn" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                    <label for="translateViEn" class="ml-2 font-medium text-purple-700 cursor-pointer">D·ªãch Vi·ªát ‚ûù Anh</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="translateEnVi" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                    <label for="translateEnVi" class="ml-2 font-medium text-purple-700 cursor-pointer">D·ªãch Anh ‚ûù Vi·ªát</label>
                </div>
            </div>

            <!-- Global Progress Bar -->
            <div id="globalProgressContainer" class="hidden mt-4 w-full bg-gray-200 rounded-full h-1.5">
                <div id="globalProgressBar" class="bg-blue-600 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- TABS CONTAINER -->
        <div id="mainTabsContainer" class="hidden">
            <div class="flex overflow-x-auto border-b border-gray-200 mb-4 no-scrollbar" id="tabsNav"></div>
            <div id="tabsContentArea"></div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-10 text-gray-400">
            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <p>K·∫øt qu·∫£ t√¨m ki·∫øm s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y</p>
        </div>

    </div>

    <!-- BOOKMARK MODAL -->
    <div id="bookmarkModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleBookmarkModal()"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-lg mx-auto rounded shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b mb-4">
                    <p class="text-2xl font-bold text-gray-700">üìå Bookmarks</p>
                    <div class="modal-close cursor-pointer" onclick="toggleBookmarkModal()"><svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg></div>
                </div>
                <div class="bg-gray-50 p-3 rounded-md mb-4 border border-gray-200">
                    <h4 class="text-sm font-semibold text-gray-600 mb-2">Th√™m m·ªõi:</h4>
                    <input type="text" id="bmName" placeholder="T√™n g·ª£i nh·ªõ" class="w-full mb-2 p-2 border rounded text-sm">
                    <input type="text" id="bmPath" placeholder="ƒê∆∞·ªùng d·∫´n folder ho·∫∑c Link..." class="w-full mb-2 p-2 border rounded text-sm">
                    <button onclick="addBookmark()" class="w-full bg-blue-600 text-white p-2 rounded text-sm font-bold hover:bg-blue-700">Th√™m Bookmark</button>
                </div>
                <div id="bookmarkList" class="space-y-2 max-h-60 overflow-y-auto pr-1"></div>
                <div class="mt-4 pt-2 text-right border-t"><button onclick="toggleBookmarkModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded text-sm">ƒê√≥ng</button></div>
            </div>
        </div>
    </div>

    <script>
        // --- CORE VARIABLES ---
        let searchIdCounter = 0;
        let isProcessing = false;

        // --- UI LOGIC & DRAG DROP ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileCountLabel = document.getElementById('fileCountLabel');

        fileInput.addEventListener('change', function() { updateFileLabel(this.files); });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
            document.body.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => dropZone.classList.add('border-blue-500', 'bg-blue-100'));
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.classList.remove('border-blue-500', 'bg-blue-100');
            dropZone.classList.add('border-gray-300', 'bg-gray-50');
        });

        dropZone.addEventListener('drop', e => {
            const files = e.dataTransfer.files;
            if (files.length > 0) { fileInput.files = files; updateFileLabel(files); }
        });

        function updateFileLabel(files) {
            const count = files.length;
            if (count > 0) {
                fileCountLabel.textContent = `ƒê√£ ch·ªçn ${count} file`;
                fileCountLabel.classList.add('text-green-600', 'font-bold');
            } else {
                fileCountLabel.textContent = 'Ch∆∞a ch·ªçn file n√†o';
                fileCountLabel.classList.remove('text-green-600', 'font-bold');
            }
        }

        // --- TAB MANAGEMENT LOGIC (RESTORED) ---
        function createNewTab(keyword, translatedInfos) {
            searchIdCounter++;
            const tabId = `tab-${searchIdCounter}`;
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('mainTabsContainer').classList.remove('hidden');

            const tabBtn = document.createElement('button');
            tabBtn.className = 'tab-btn flex items-center px-4 py-2 mr-2 text-sm font-medium text-gray-500 bg-white border border-transparent rounded-t-lg hover:text-gray-700 hover:border-gray-300 focus:outline-none';
            tabBtn.dataset.target = tabId;
            tabBtn.innerHTML = `
                <span class="max-w-[100px] truncate" title="${keyword}">${keyword}</span>
                <span class="ml-2 text-xs bg-gray-200 text-gray-600 rounded-full px-1.5 py-0.5" id="badge-${tabId}">...</span>
                <span class="ml-2 text-gray-400 hover:text-red-500 rounded-full p-0.5" onclick="closeTab('${tabId}', event)">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </span>
            `;
            tabBtn.onclick = (e) => switchTab(tabId);
            document.getElementById('tabsNav').appendChild(tabBtn);

            const contentDiv = document.createElement('div');
            contentDiv.id = tabId;
            contentDiv.className = 'tab-content';
            
            let transHtml = '';
            if (translatedInfos && translatedInfos.length > 0) {
                const badges = translatedInfos.map(info => {
                    if (info.error) return `<div class="mr-2 mb-1 bg-yellow-50 text-yellow-800 text-xs px-3 py-1 rounded border border-yellow-200 inline-block" title="${info.error}"><span class="font-bold text-red-500">‚ö† ${info.label}:</span> ${info.error}</div>`;
                    else if (info.isDuplicate) return `<div class="mr-2 mb-1 bg-gray-50 text-gray-500 text-xs px-3 py-1 rounded border border-gray-200 inline-block italic"><span class="font-bold">${info.label}:</span> Tr√πng kh·ªõp (ƒê√£ b·ªè qua)</div>`;
                    else return `<div class="mr-2 mb-1 bg-blue-50 text-blue-800 text-xs px-3 py-1 rounded border border-blue-100 inline-block"><span class="font-bold">${info.label}:</span> "${keyword}" ‚Üî "${info.text}"</div>`;
                }).join('');
                transHtml = `<div class="mb-3 flex flex-wrap">${badges}</div>`;
            }

            contentDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">K·∫øt qu·∫£ cho: <span class="text-blue-600">"${keyword}"</span></h2>
                    <div id="status-${tabId}" class="text-sm font-medium text-orange-500 flex items-center">
                        <div class="loader mr-2"></div> ƒêang kh·ªüi t·∫°o...
                    </div>
                </div>
                ${transHtml}
                <ul id="list-${tabId}" class="space-y-4 pb-10 min-h-[200px]"></ul>
            `;
            document.getElementById('tabsContentArea').appendChild(contentDiv);

            switchTab(tabId);
            return tabId;
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const btn = document.querySelector(`.tab-btn[data-target="${tabId}"]`);
            const content = document.getElementById(tabId);
            if (btn && content) {
                btn.classList.add('active');
                content.classList.add('active');
            }
        }

        function closeTab(tabId, event) {
            event.stopPropagation();
            const btn = document.querySelector(`.tab-btn[data-target="${tabId}"]`);
            const content = document.getElementById(tabId);
            if (btn) btn.remove();
            if (content) content.remove();
            if (!document.querySelector('.tab-btn.active')) {
                const remainingBtns = document.querySelectorAll('.tab-btn');
                if (remainingBtns.length > 0) switchTab(remainingBtns[remainingBtns.length - 1].dataset.target);
                else {
                    document.getElementById('mainTabsContainer').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');
                }
            }
        }

        // --- CONTENT EXTRACTION LOGIC (THE CORE UPGRADE) ---
        async function extractContentFromFile(file) {
            const name = file.name.toLowerCase();
            const ext = name.split('.').pop();
            
            try {
                if (ext === 'pdf') {
                    return await extractPDF(file);
                } else if (ext === 'docx') {
                    return await extractDOCX(file);
                } else if (['xlsx', 'xls', 'csv'].includes(ext)) {
                    return await extractExcel(file);
                } else if (['txt', 'html', 'htm', 'xml', 'json', 'mhtml'].includes(ext)) {
                    return await extractTextFile(file);
                } else {
                    return [{ pageNum: 1, text: "", error: "ƒê·ªãnh d·∫°ng kh√¥ng h·ªó tr·ª£" }];
                }
            } catch (e) {
                console.error("Extraction Error:", e);
                return [{ pageNum: 1, text: "", error: "L·ªói ƒë·ªçc file: " + e.message }];
            }
        }

        // 1. PDF Extractor
        async function extractPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const totalPages = pdf.numPages;
            const pages = [];
            const useOCR = document.getElementById('useOCR').checked;
            const strictTable = document.getElementById('strictTable').checked;
            
            // Lazy OCR loader
            let worker = null;
            if(useOCR) worker = await Tesseract.createWorker('vie');

            for (let i = 1; i <= totalPages; i++) {
                const page = await pdf.getPage(i);
                let text = "";
                if (useOCR) {
                    const viewport = page.getViewport({ scale: 2.0 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height; canvas.width = viewport.width;
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    const res = await worker.recognize(canvas);
                    text = res.data.text;
                } else {
                    const textContent = await page.getTextContent();
                    if (strictTable) text = extractTextWithLayout(textContent);
                    else text = textContent.items.map(item => item.str).join(' ');
                }
                pages.push({ pageNum: i, text: text });
            }
            if(worker) await worker.terminate();
            return pages;
        }

        // 2. DOCX Extractor (Using Mammoth)
        async function extractDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
            // Word doesn't have strict "pages" in code structure, treat as 1 long page
            return [{ pageNum: 1, text: result.value }];
        }

        // 3. Excel Extractor (Using SheetJS)
        async function extractExcel(file) {
            const arrayBuffer = await file.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const pages = [];
            workbook.SheetNames.forEach((sheetName, index) => {
                const sheet = workbook.Sheets[sheetName];
                // Convert to CSV for searchable text
                const text = XLSX.utils.sheet_to_csv(sheet); 
                if (text && text.trim()) {
                    pages.push({ pageNum: index + 1, sheetName: sheetName, text: text });
                }
            });
            return pages;
        }

        // 4. Text/HTML Extractor
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        async function extractTextFile(file) {
            const text = await readFileAsText(file);
            // Basic HTML tag stripping if it looks like HTML
            let cleanText = text;
            if (file.name.match(/\.(html|htm|xml)$/i)) {
                const tmp = document.createElement("DIV");
                tmp.innerHTML = text;
                cleanText = tmp.textContent || tmp.innerText || "";
            }
            return [{ pageNum: 1, text: cleanText }];
        }

        // --- HELPER: PDF Layout Logic ---
        function extractTextWithLayout(textContent) {
            const items = textContent.items;
            if (items.length === 0) return "";
            items.sort((a, b) => {
                const yDiff = Math.abs(a.transform[5] - b.transform[5]);
                return yDiff < 4 ? a.transform[4] - b.transform[4] : b.transform[5] - a.transform[5];
            });
            let text = ""; let lastY = -1;
            for (const item of items) {
                if (lastY !== -1 && Math.abs(item.transform[5] - lastY) > 5) text += "\n";
                else if (lastY !== -1) text += "   ";
                text += item.str; lastY = item.transform[5];
            }
            return text + "\n";
        }

        // --- MAIN SEARCH LOGIC ---
        async function processFiles() {
            const keywordInput = document.getElementById('keywordInput');
            const urlInput = document.getElementById('urlInput');
            const searchMode = document.getElementById('searchMode').value;
            const useViEn = document.getElementById('translateViEn').checked;
            const useEnVi = document.getElementById('translateEnVi').checked;
            const globalProgressBar = document.getElementById('globalProgressBar');
            const globalProgressContainer = document.getElementById('globalProgressContainer');

            const originalKeyword = keywordInput.value.trim();
            const pastedUrl = urlInput.value.trim();
            const hasFiles = fileInput.files.length > 0;
            const hasUrl = pastedUrl.length > 0;

            if (!hasFiles && !hasUrl) { alert('Vui l√≤ng ch·ªçn file ho·∫∑c nh·∫≠p Link.'); return; }
            if (!originalKeyword) { alert('Vui l√≤ng nh·∫≠p t·ª´ kh√≥a.'); return; }

            // Save History
            addToHistory('keyword', originalKeyword);
            if(hasUrl) addToHistory('url', pastedUrl);

            isProcessing = true;
            document.getElementById('btnProcess').disabled = true;
            document.getElementById('btnProcess').classList.add('opacity-50');
            globalProgressContainer.classList.remove('hidden');
            globalProgressBar.style.width = '5%';

            // Translation
            let searchKeywords = [originalKeyword];
            let translatedInfos = [];
            if (useViEn) {
                const t = await translateKeyword(originalKeyword, 'vi|en');
                if (t.text) searchKeywords.push(t.text); translatedInfos.push(t);
            }
            if (useEnVi) {
                const t = await translateKeyword(originalKeyword, 'en|vi');
                if (t.text && !searchKeywords.includes(t.text)) searchKeywords.push(t.text); translatedInfos.push(t);
            }

            const tabId = createNewTab(originalKeyword, translatedInfos);
            const tabStatus = document.getElementById(`status-${tabId}`);
            const tabList = document.getElementById(`list-${tabId}`);
            const tabBadge = document.getElementById(`badge-${tabId}`);

            // Regex Setup
            const lowerKeywords = searchKeywords.map(k => k.toLowerCase());
            const regexPattern = searchKeywords.map(k => k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|');
            const highlightRegex = new RegExp(`(${regexPattern})`, 'gi');
            const smartKeywordsParts = lowerKeywords.map(k => k.split(' ').filter(w => w.trim().length > 0));

            try {
                let totalMatchesInTab = 0;
                const tasks = [];
                Array.from(fileInput.files).forEach(file => tasks.push({ type: 'file', source: file, name: file.name }));
                
                if (hasUrl) {
                    let fetchUrl = pastedUrl;
                    if (fetchUrl.includes('drive.google.com/file/d/')) {
                         const match = fetchUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
                         if (match) fetchUrl = `https://drive.google.com/uc?export=download&id=${match[1]}`;
                    }
                    tasks.push({ type: 'url', source: fetchUrl, name: "Link: " + pastedUrl.substring(0,20)+'...' });
                }

                for (let i = 0; i < tasks.length; i++) {
                    const task = tasks[i];
                    tabStatus.innerHTML = `<div class="loader mr-2"></div> ƒêang x·ª≠ l√Ω: ${task.name} (${i+1}/${tasks.length})`;
                    
                    let pagesData = [];
                    try {
                        if (task.type === 'file') {
                            pagesData = await extractContentFromFile(task.source);
                        } else {
                            // Simple Proxy fetch for URL
                            const res = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(task.source));
                            if(!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i link");
                            const blob = await res.blob();
                            // Mock a File object
                            const mockFile = new File([blob], "downloaded_file.pdf", { type: blob.type }); 
                            // Note: Detecting type from URL blob is hard, defaulting to PDF for safety or need mimetype check
                            // For this demo, we try to guess or default. 
                            pagesData = await extractContentFromFile(mockFile); 
                        }
                    } catch (e) {
                        console.warn(e);
                        pagesData = [{ pageNum: 1, text: "", error: e.message }];
                    }

                    // --- SEARCH WITHIN CONTENT ---
                    const fileResults = [];
                    
                    pagesData.forEach(page => {
                        if (page.error) return;
                        
                        const pageText = page.text;
                        // Determine file type badge
                        let badgeType = 'txt';
                        if (task.name.endsWith('.pdf')) badgeType = 'pdf';
                        else if (task.name.endsWith('.docx')) badgeType = 'docx';
                        else if (task.name.endsWith('.xlsx')) badgeType = 'xlsx';

                        // Sentence Split
                        let sentences = pageText.replace(/([.?!])\s*(?=[A-Z])/g, "$1|").split("|"); // Simple split
                        if(badgeType === 'xlsx') sentences = pageText.split('\n'); // Excel split by row

                        sentences.forEach((sentence, sIdx) => {
                            const cleanLine = sentence.trim();
                            if(!cleanLine) return;
                            
                            const lineLower = cleanLine.toLowerCase();
                            let isMatch = false;

                            for (let kIdx = 0; kIdx < lowerKeywords.length; kIdx++) {
                                const kw = lowerKeywords[kIdx];
                                if (searchMode === 'exact') {
                                    const r = new RegExp(`\\b${kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
                                    if (r.test(cleanLine)) { isMatch = true; break; }
                                } else if (searchMode === 'smart') {
                                    const parts = smartKeywordsParts[kIdx];
                                    if (parts.every(p => lineLower.includes(p))) { isMatch = true; break; }
                                } else {
                                    if (lineLower.includes(kw)) { isMatch = true; break; }
                                }
                            }

                            if (isMatch) {
                                fileResults.push({
                                    content: cleanLine,
                                    pageNum: page.pageNum,
                                    sheetName: page.sheetName,
                                    fullPageText: pageText,
                                    badgeType: badgeType
                                });
                            }
                        });
                    });

                    // --- RENDER RESULTS ---
                    if (fileResults.length > 0) {
                        totalMatchesInTab += fileResults.length;
                        const header = document.createElement('div');
                        header.className = "file-header";
                        let badgeClass = `type-${fileResults[0].badgeType}`;
                        header.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="type-badge ${badgeClass}">${fileResults[0].badgeType}</span>
                                    <span>${task.name}</span>
                                </div>
                                <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded">${fileResults.length} k·∫øt qu·∫£</span>
                            </div>`;
                        tabList.appendChild(header);

                        fileResults.forEach((res, idx) => {
                            const li = document.createElement('li');
                            li.className = "bg-white p-4 rounded-lg shadow border-l-4 border-gray-300 hover:border-blue-500 transition mb-4 ml-4";
                            const uniqueId = `${tabId}-${i}-${idx}`;
                            
                            // Highlight Logic
                            let displayLine = res.content;
                            let fullHTML = res.fullPageText.replace(/[<>]/g, ""); 
                            
                            if (searchMode === 'smart') {
                                smartKeywordsParts.forEach(parts => {
                                    parts.forEach(p => {
                                        const r = new RegExp(`(${p.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                                        displayLine = displayLine.replace(r, `<span class="highlight">$1</span>`);
                                        fullHTML = fullHTML.replace(r, `<span class="highlight">$1</span>`);
                                    });
                                });
                            } else {
                                displayLine = displayLine.replace(highlightRegex, `<span class="highlight">$1</span>`);
                                fullHTML = fullHTML.replace(highlightRegex, `<span class="highlight">$1</span>`);
                            }

                            // Location Label
                            let locLabel = `Trang ${res.pageNum}`;
                            if (res.sheetName) locLabel = `Sheet: ${res.sheetName}`;

                            // Translate Logic
                            let transId = `trans-${uniqueId}`;
                            let transHtml = '';
                            if (!isVietnameseText(res.content)) {
                                transHtml = `<div class="translation-block" id="${transId}"><div class="loader mini-loader mr-2 inline-block"></div> <span class="italic text-gray-400">ƒêang d·ªãch...</span></div>`;
                                fetchAndDisplayTranslation(res.content, transId);
                            }

                            li.innerHTML = `
                                <div class="flex justify-between items-start mb-2">
                                    <div class="text-xs font-bold text-gray-400">#${idx + 1} ‚Ä¢ ${locLabel}</div>
                                    <button id="btn-${uniqueId}" onclick="toggleResultView('${uniqueId}')" class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded border border-blue-200 transition">
                                        üìñ Xem ƒë·∫ßy ƒë·ªß
                                    </button>
                                </div>
                                <div id="snippet-${uniqueId}" class="result-content text-sm block">${displayLine}</div>
                                <div id="full-${uniqueId}" class="full-content-view hidden">
                                    <span class="page-badge">${locLabel}</span>
                                    ${fullHTML}
                                </div>
                                ${transHtml}
                            `;
                            tabList.appendChild(li);
                        });
                    }
                    globalProgressBar.style.width = `${((i+1)/tasks.length)*100}%`;
                }

                // Finish
                if (totalMatchesInTab === 0) {
                    tabStatus.className = "text-sm font-bold text-red-500";
                    tabStatus.textContent = "Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.";
                    tabList.innerHTML = `<div class="text-center text-gray-400 italic mt-10">Kh√¥ng c√≥ d·ªØ li·ªáu tr√πng kh·ªõp.</div>`;
                } else {
                    tabStatus.className = "text-sm font-bold text-green-600";
                    tabStatus.textContent = `Ho√†n t·∫•t! T√¨m th·∫•y ${totalMatchesInTab} k·∫øt qu·∫£.`;
                }
                tabBadge.textContent = totalMatchesInTab;
                tabBadge.className = `ml-2 text-xs px-1.5 py-0.5 rounded-full text-white ${totalMatchesInTab > 0 ? 'bg-red-500' : 'bg-gray-400'}`;

            } catch (err) {
                console.error(err);
                tabStatus.textContent = "L·ªói: " + err.message;
                tabStatus.className = "text-red-600 font-bold";
            } finally {
                isProcessing = false;
                document.getElementById('btnProcess').disabled = false;
                document.getElementById('btnProcess').classList.remove('opacity-50');
                setTimeout(() => document.getElementById('globalProgressContainer').classList.add('hidden'), 1000);
            }
        }

        // --- VIEW TOGGLE & AUTO SCROLL ---
        function toggleResultView(id) {
            const snip = document.getElementById(`snippet-${id}`);
            const full = document.getElementById(`full-${id}`);
            const btn = document.getElementById(`btn-${id}`);
            
            if (snip.classList.contains('hidden')) {
                snip.classList.remove('hidden'); full.classList.add('hidden');
                btn.innerHTML = 'üìñ Xem ƒë·∫ßy ƒë·ªß'; btn.classList.replace('bg-gray-500', 'bg-blue-100'); btn.classList.replace('text-white', 'text-blue-700');
            } else {
                snip.classList.add('hidden'); full.classList.remove('hidden');
                btn.innerHTML = 'üîº Thu g·ªçn'; btn.classList.replace('bg-blue-100', 'bg-gray-500'); btn.classList.replace('text-blue-700', 'text-white');
                setTimeout(() => {
                    const h = full.querySelector('.highlight');
                    if(h) h.scrollIntoView({behavior: 'smooth', block: 'center'});
                }, 100);
            }
        }

        // --- HISTORY & UTILS ---
        const HISTORY_KEYS = { keyword: 'pdf_history_keywords', url: 'pdf_history_urls' };
        function loadHistory() { updateDatalist('keywordHistoryList', HISTORY_KEYS.keyword); updateDatalist('urlHistoryList', HISTORY_KEYS.url); }
        function updateDatalist(id, key) {
            const list = document.getElementById(id); list.innerHTML = '';
            JSON.parse(localStorage.getItem(key) || '[]').forEach(v => { const opt = document.createElement('option'); opt.value = v; list.appendChild(opt); });
        }
        function addToHistory(type, val) {
            if (!val) return;
            const key = HISTORY_KEYS[type];
            let h = JSON.parse(localStorage.getItem(key) || '[]');
            h = h.filter(i => i !== val); h.unshift(val); if (h.length > 20) h.pop();
            localStorage.setItem(key, JSON.stringify(h));
            updateDatalist(type === 'keyword' ? 'keywordHistoryList' : 'urlHistoryList', key);
        }
        function clearHistory(type) {
            if(confirm('X√≥a l·ªãch s·ª≠?')) { localStorage.removeItem(HISTORY_KEYS[type]); loadHistory(); }
        }

        // --- BOOKMARK LOGIC (Keep previous logic) ---
        const BOOKMARK_KEY = 'pdf_app_bookmarks'; let bookmarks = [];
        function initBookmarks() { try { bookmarks = JSON.parse(localStorage.getItem(BOOKMARK_KEY) || '[]'); } catch(e){bookmarks=[]} renderBookmarks(); }
        function toggleBookmarkModal() { document.querySelector('body').classList.toggle('modal-active'); document.getElementById('bookmarkModal').classList.toggle('opacity-0'); document.getElementById('bookmarkModal').classList.toggle('pointer-events-none'); }
        function addBookmark() { 
            const n = document.getElementById('bmName').value.trim(); const p = document.getElementById('bmPath').value.trim();
            if(!n || !p) return alert('Nh·∫≠p ƒë·ªß th√¥ng tin!');
            bookmarks.push({name:n, path:p, id:Date.now()}); localStorage.setItem(BOOKMARK_KEY, JSON.stringify(bookmarks)); renderBookmarks();
            document.getElementById('bmName').value=''; document.getElementById('bmPath').value='';
        }
        function renderBookmarks() {
            const c = document.getElementById('bookmarkList'); c.innerHTML = '';
            if(bookmarks.length===0) return c.innerHTML='<p class="text-center text-gray-400 text-sm">Ch∆∞a c√≥ bookmark.</p>';
            bookmarks.forEach(b => {
                const isUrl = b.path.startsWith('http');
                c.innerHTML += `<div class="flex justify-between items-center bg-white border p-2 rounded shadow-sm text-sm mb-2">
                    <div class="overflow-hidden mr-2"><div class="font-bold truncate">${b.name}</div><div class="text-gray-400 truncate text-xs">${b.path}</div></div>
                    <div class="shrink-0 flex items-center">
                        ${isUrl ? `<a href="${b.path}" target="_blank" class="text-blue-600 mr-2">M·ªü</a>` : `<button onclick="navigator.clipboard.writeText('${b.path.replace(/\\/g,'\\\\')}')" class="text-gray-600 mr-2">Copy</button>`}
                        <button onclick="bookmarks=bookmarks.filter(x=>x.id!=${b.id});localStorage.setItem('${BOOKMARK_KEY}',JSON.stringify(bookmarks));renderBookmarks()" class="text-red-500">√ó</button>
                    </div>
                </div>`;
            });
        }

        // --- TRANSLATION HELPERS ---
        async function translateKeyword(text, lang) {
            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${lang}&mt=1`);
                const d = await res.json();
                if(d.responseStatus===200) return { text: d.responseData.translatedText, label: lang };
            } catch(e){} return { text: null, error: 'L·ªói' };
        }
        function isVietnameseText(text) { return /[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/i.test(text); }
        async function fetchAndDisplayTranslation(text, id) {
            const el = document.getElementById(id); if(!el) return;
            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|vi&mt=1`);
                const d = await res.json();
                if(d.responseStatus===200) el.innerHTML = `<span class="font-bold text-blue-600">üí° D·ªãch:</span> ${d.responseData.translatedText}`;
                else el.style.display='none';
            } catch(e) { el.innerHTML='L·ªói d·ªãch'; }
        }

        window.addEventListener('DOMContentLoaded', () => { loadHistory(); initBookmarks(); });
    </script>
</body>
</html>
